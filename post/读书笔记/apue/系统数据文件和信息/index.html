<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>系统数据文件和信息 | 生如夏花</title><meta property="og:title" content="系统数据文件和信息 - 生如夏花"><meta property="og:type" content="article"><meta property="article:published_time" content='2022-04-05T12:21:20+08:00'><meta property="article:modified_time" content='2022-04-05T12:21:20+08:00'><meta name=Keywords content="C语言,Linux系统开发,物联网,博客,项目管理,软件架构"><meta name=description content="本文主要介绍了口令文件/etc/passwd、阴影口令/etc/shadow、组文件/etc/group等内容格式以及解析方式，还是登录账户标志wtmp、utmp以及时间(timeval_t、)、时钟CLOCK等信息。"><meta name=author content><meta property="og:url" content="https://DBL2017.github.io/post/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/apue/%E7%B3%BB%E7%BB%9F%E6%95%B0%E6%8D%AE%E6%96%87%E4%BB%B6%E5%92%8C%E4%BF%A1%E6%81%AF/"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css><link rel=stylesheet href=/css/badge.min.dc57f0a9d275742b1e2d17f204ae0b829361b5dd0df99d3d356615830fb223936c054d31a888c5f369975da90586601e2666ddbbbb36e98510b814a70826e874.css integrity="sha512-3FfwqdJ1dCseLRfyBK4LgpNhtd0N+Z09NWYVgw+yI5NsBU0xqIjF82mXXakFhmAeJmbdu7s26YUQuBSnCCbodA==" crossorigin=anonymous><link rel=stylesheet href=/css/header.min.9e74ad2f7e23fb54e2da3ef2f1eb6498897cd4139d181133b5e641f107980364ccfbcea731badb693b4a50819c388b6f8cab037346daf142114f86f14faa8766.css integrity="sha512-nnStL34j+1Ti2j7y8etkmIl81BOdGBEzteZB8QeYA2TM+86nMbrbaTtKUIGcOItvjKsDc0ba8UIRT4bxT6qHZg==" crossorigin=anonymous><link rel=stylesheet href=/css/table.min.c193c9134b7b9c6f88c84f2b6e189f1783056a6c6a7eab574e1ec8f1537bbbb4b3c44e130004fbb98e9e2f260c7485a74e96db4bd156e1f49a20013ab811e874.css integrity="sha512-wZPJE0t7nG+IyE8rbhifF4MFamxqfqtXTh7I8VN7u7SzxE4TAAT7uY6eLyYMdIWnTpbbS9FW4fSaIAE6uBHodA==" crossorigin=anonymous><link rel=stylesheet href=/css/baseof.min.5e04a6c8338c3c57aedaaae91320971e148651ac160d51bb58ebfec7757346a177331ac5646bbb1b2664b1c8cc405939125785c138935bc0d29a805b11791691.css integrity="sha512-XgSmyDOMPFeu2qrpEyCXHhSGUawWDVG7WOv+x3VzRqF3MxrFZGu7GyZkscjMQFk5EleFwTiTW8DSmoBbEXkWkQ==" crossorigin=anonymous><link rel=stylesheet href=/css/rocket.min.96a6be31cd3df9dcd4e7e131e9fcb0e63149da1da6a23df5ed8c8e0ccf0436f4c95aad5ded6a69e7fba5c051f8cc00466fcedaa07e4c7f59492d4a15aba2e936.css integrity="sha512-lqa+Mc09+dzU5+Ex6fyw5jFJ2h2moj317YyODM8ENvTJWq1d7Wpp5/ulwFH4zABGb87aoH5Mf1lJLUoVq6LpNg==" crossorigin=anonymous><link rel=stylesheet href=/css/toc.min.d258716c8e1217faa5525b82fb1a32c1980ba7419cb92684a219afc52bd8eb1034c9281e43ccd7bff11764339c91a03777eaa6d36e863f1c69a45fd05fbeaf7f.css integrity="sha512-0lhxbI4SF/qlUluC+xoywZgLp0GcuSaEohmvxSvY6xA0ySgeQ8zXv/EXZDOckaA3d+qm026GPxxppF/QX76vfw==" crossorigin=anonymous><link rel=stylesheet href=/css/clipboard.min.5e6a0198e50c850ced7dc2ba6f282ecaab21a8daad9eee626b990120818361b4b0007128d73957d5682346c88a6f9831f5872051e5f12da830cc29ca75676403.css integrity="sha512-XmoBmOUMhQztfcK6byguyqshqNqtnu5ia5kBIIGDYbSwAHEo1zlX1WgjRsiKb5gx9YcgUeXxLagwzCnKdWdkAw==" crossorigin=anonymous><link rel=stylesheet href=/css/style.min.578ca33085c2a1fbdbaa4560d60ba2988a35469db6220306455f1d0e84bece0a661501e6536fc84ccbf5b6cb795d5e9c177595804d5aa204861f80ff4003bd73.css integrity="sha512-V4yjMIXCofvbqkVg1guimIo1Rp22IgMGRV8dDoS+zgpmFQHmU2/ITMv1tst5XV6cF3WVgE1aogSGH4D/QAO9cw==" crossorigin=anonymous><link rel="shortcut icon" href=/img/favicon.png type=image/x-icon><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/vim.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/latex.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/dos.min.js></script><script src=/js/gumshoe.min.min.9dec1df0371d73b03324ed4bb78a6d5b2e84af6a37b11ce799808a26d70dfd156595f8d23c42db9e4866f12b4c0de664cfd032fa6f95bdaaada1bacdb235e79e.js integrity="sha512-newd8Dcdc7AzJO1Lt4ptWy6Er2o3sRznmYCKJtcN/RVllfjSPELbnkhm8StMDeZkz9Ay+m+VvaqtobrNsjXnng==" crossorigin=anonymous></script></head><body><div class=container><div class=container-header><header><div class=header-main><div class=header-site-name><a id=header-title href=https://DBL2017.github.io/>生如夏花</a><p class=description>专注于工业物联网行业数据采集，嵌入式Linux系统裁剪，5G智慧网关软件开发等</p></div><div class=header-menu><nav id=header-nav-menu><a href=https://DBL2017.github.io/>首页</a>
<a href=https://DBL2017.github.io/series/ title=系列>系列</a>
<a href=https://DBL2017.github.io/categories/ title=分类>分类</a>
<a href=https://DBL2017.github.io/tags/ title=标签>标签</a>
<a href=https://DBL2017.github.io/archives/ title=归档>归档</a>
<a href=https://DBL2017.github.io/about/ title=关于>关于</a></nav></div></div></header></div><div class=container-content><div class=content-center><div class=main-single><div class=single-toc><div class=post-toc><h2 class=post-toc-title><a href=#>目录</a></h2><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#口令>口令</a><ul><li><a href=#口令文件>口令文件</a></li><li><a href=#阴影口令>阴影口令</a></li></ul></li><li><a href=#组>组</a><ul><li><a href=#附属组>附属组</a></li></ul></li><li><a href=#其他数据文件>其他数据文件</a></li><li><a href=#登录账户>登录账户</a></li><li><a href=#系统标识>系统标识</a></li><li><a href=#时间>时间</a><ul><li><a href=#结构体>结构体</a></li><li><a href=#获取和设置>获取和设置</a></li><li><a href=#时区和格式化>时区和格式化</a></li></ul></li></ul></nav></div></div></div><div class=single-article><article class=post><header><h1 class=post-title>系统数据文件和信息</h1></header><date class="post-meta meta-date"><span class=meta-category><a href=/archives/#2022>2022年4月5日</a></span></date><div class=post-meta><span>|</span>
<span class=meta-category><a href=/categories/#%e8%af%bb%e4%b9%a6%e7%ac%94%e8%ae%b0>读书笔记</a></span></div><div class=post-meta><span>|</span>
<span class=meta-category><a href=/series/#APUE>APUE</a></span></div><div class=post-meta><span>|</span>
<span>共6403字</span></div><div class=post-meta><span>|</span>
<span>阅读时长(13分钟)</span></div><div class=clear style=display:none><div class=toc-article><div class=toc-title>文章目录</div></div></div><div class=post-content><p>口令文件<code>/etc/passwd</code>和组文件<code>/etc/group</code>经常被多个进程频繁使用。用户每次登录Linux和使用<code>ls</code>命令都会访问口令文件。</p><p>除了直接访问文件之外，系统通过一些接口来对外提供信息，比如系统标识函数、时间和日期函数。</p><h2 id=口令><a href=#%e5%8f%a3%e4%bb%a4>口令</a></h2><h3 id=口令文件><a href=#%e5%8f%a3%e4%bb%a4%e6%96%87%e4%bb%b6>口令文件</a></h3><p>Unix口令文件<code>/etc/passwd</code>会包含下图所示的各字段，这些字段定义包含在<code>pwd.h</code>中定义的<code>passwd</code>结构体中。</p><table><thead><tr><th style=text-align:left>说明</th><th style=text-align:left><code>struct passwd</code> 成员</th><th style=text-align:center>POSIX.1</th></tr></thead><tbody><tr><td style=text-align:left>用户名</td><td style=text-align:left><code>char *pw_name</code></td><td style=text-align:center>*</td></tr><tr><td style=text-align:left>加密口令</td><td style=text-align:left><code>char *pw_passwd</code></td><td style=text-align:center></td></tr><tr><td style=text-align:left>用户ID</td><td style=text-align:left><code>uid_t pw_uid</code></td><td style=text-align:center>*</td></tr><tr><td style=text-align:left>组ID</td><td style=text-align:left><code>gid_t pw_gid</code></td><td style=text-align:center>*</td></tr><tr><td style=text-align:left>注释字段</td><td style=text-align:left><code>char *pw_gecos</code></td><td style=text-align:center></td></tr><tr><td style=text-align:left>初始工作目录</td><td style=text-align:left><code>char *pw_dir</code></td><td style=text-align:center>*</td></tr><tr><td style=text-align:left>初始shell</td><td style=text-align:left><code>char *pw_shell</code></td><td style=text-align:center>*</td></tr><tr><td style=text-align:left>用户访问类</td><td style=text-align:left><code>char *pw_class</code></td><td style=text-align:center></td></tr><tr><td style=text-align:left>下次更改口令时间</td><td style=text-align:left><code>time_t pw_change</code></td><td style=text-align:center></td></tr><tr><td style=text-align:left>账户有效时间</td><td style=text-align:left><code>time_t pw_expire</code></td><td style=text-align:center></td></tr></tbody></table><p>Linux glibc包含了前7个字段，POSIX.1指定必须包含5个字段。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* A record in the user database.  */</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>passwd</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>pw_name</span><span class=p>;</span>                <span class=cm>/* Username.  */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>pw_passwd</span><span class=p>;</span>              <span class=cm>/* Hashed passphrase, if shadow database
</span></span></span><span class=line><span class=cl><span class=cm>                                   not in use (see shadow.h).  */</span>
</span></span><span class=line><span class=cl>  <span class=n>__uid_t</span> <span class=n>pw_uid</span><span class=p>;</span>               <span class=cm>/* User ID.  */</span>
</span></span><span class=line><span class=cl>  <span class=n>__gid_t</span> <span class=n>pw_gid</span><span class=p>;</span>               <span class=cm>/* Group ID.  */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>pw_gecos</span><span class=p>;</span>               <span class=cm>/* Real name.  */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>pw_dir</span><span class=p>;</span>                 <span class=cm>/* Home directory.  */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>pw_shell</span><span class=p>;</span>               <span class=cm>/* Shell program.  */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p><code>/etc/passwd</code>文件结构如下所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ cat /etc/passwd
</span></span><span class=line><span class=cl>root:x:0:0:root:/root:/bin/bash
</span></span><span class=line><span class=cl>nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
</span></span><span class=line><span class=cl>blduan:x:1000:1000:blduan:/home/blduan:/bin/bash
</span></span><span class=line><span class=cl>test:x:1001:1001::/home/test:/bin/bash
</span></span><span class=line><span class=cl>sshd:x:127:65534::/run/sshd:/usr/sbin/nologin
</span></span></code></pre></div><p>内容解析：</p><ul><li>通常有一个用户名为<code>root</code>的登录项，用户ID=0。</li><li>加密口令字段包含了一个占位符x。早期Unix中此处是加密口令，处于安全考虑，已经将加密口令单独放在文件<code>/etc/shadow</code>中。</li><li>口令文件项中某些字段可能为空，<code>test</code>和<code>sshd</code>用户的注释字段为空。</li><li><code>shell</code>字段包含了一个可执行程序名，它是被用作该用户的登录<code>shell</code>。若该字段为空吗，则取系统默认值，通常为<code>/bin/bash</code>。使用<code>/usr/sbin/nologin</code>是为了不允许用户登录，并使用该程序打印指定错误。</li><li><code>nobody</code>用户名的一个目的是，是任何人都可以登录该系统，但其用户ID（65534）和组ID（65534）不提供任何特权。该用户ID和组ID只能访问人人皆可读写的文件。可以用来</li></ul><p>Ubuntu提供了<code>vipw</code>命令，可以使用该命令编辑<code>/etc/passwd</code>，使用该命令的好处是可以确保它做的更改与其他相关文件保持一致。</p><p>POSIX.1定义了两个获取口令文件项的函数。在给出用户登录名或用户ID后，可以通过这两个函数查看其它项。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;pwd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>passwd</span><span class=o>*</span> <span class=nf>getpwuid</span><span class=p>(</span><span class=kt>uid_t</span> <span class=n>uid</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>passwd</span><span class=o>*</span> <span class=nf>getpwnam</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/* 成功返回passwd结构体指针，失败返回NULL */</span>
</span></span></code></pre></div><p><code>getpwuid</code>函数有<code>ls</code>使用，参数为i节点中的用户ID。<code>getpwnam</code>函数有<code>login</code>程序调用。</p><p><code>passwd</code>通常为函数内部的静态变量，只要调用任一相关函数，其内容就会被重写。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;pwd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>passwd</span><span class=o>*</span> <span class=n>pPWD</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>pPWD</span> <span class=o>=</span> <span class=nf>getpwnam</span><span class=p>(</span><span class=s>&#34;blduan&#34;</span><span class=p>))</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pw_name=%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pPWD</span><span class=o>-&gt;</span><span class=n>pw_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pw_passwd=%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pPWD</span><span class=o>-&gt;</span><span class=n>pw_passwd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pw_uid=%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pPWD</span><span class=o>-&gt;</span><span class=n>pw_uid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pw_gid=%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pPWD</span><span class=o>-&gt;</span><span class=n>pw_gid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pw_gecos=%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pPWD</span><span class=o>-&gt;</span><span class=n>pw_gecos</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pw_dir=%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pPWD</span><span class=o>-&gt;</span><span class=n>pw_dir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pw_shell=%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pPWD</span><span class=o>-&gt;</span><span class=n>pw_shell</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>pPWD</span> <span class=o>=</span><span class=nf>getpwuid</span><span class=p>(</span><span class=mi>1001</span><span class=p>))</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pw_name=%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pPWD</span><span class=o>-&gt;</span><span class=n>pw_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pw_passwd=%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pPWD</span><span class=o>-&gt;</span><span class=n>pw_passwd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pw_uid=%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pPWD</span><span class=o>-&gt;</span><span class=n>pw_uid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pw_gid=%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pPWD</span><span class=o>-&gt;</span><span class=n>pw_gid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pw_gecos=%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pPWD</span><span class=o>-&gt;</span><span class=n>pw_gecos</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pw_dir=%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pPWD</span><span class=o>-&gt;</span><span class=n>pw_dir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pw_shell=%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pPWD</span><span class=o>-&gt;</span><span class=n>pw_shell</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>执行结果如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ cat /etc/passwd <span class=p>|</span> grep <span class=s1>&#39;blduan&#39;</span>
</span></span><span class=line><span class=cl>blduan:x:1000:1000:blduan:/home/blduan:/bin/bash
</span></span><span class=line><span class=cl>$ cat /etc/passwd <span class=p>|</span> grep <span class=s1>&#39;1001&#39;</span>
</span></span><span class=line><span class=cl>test:x:1001:1001::/home/test:/bin/bash
</span></span><span class=line><span class=cl>$ ./passwd_info_by_user_or_id
</span></span><span class=line><span class=cl><span class=nv>pw_name</span><span class=o>=</span>blduan
</span></span><span class=line><span class=cl><span class=nv>pw_passwd</span><span class=o>=</span>x
</span></span><span class=line><span class=cl><span class=nv>pw_uid</span><span class=o>=</span><span class=m>1000</span>
</span></span><span class=line><span class=cl><span class=nv>pw_gid</span><span class=o>=</span><span class=m>1000</span>
</span></span><span class=line><span class=cl><span class=nv>pw_gecos</span><span class=o>=</span>blduan
</span></span><span class=line><span class=cl><span class=nv>pw_dir</span><span class=o>=</span>/home/blduan
</span></span><span class=line><span class=cl><span class=nv>pw_shell</span><span class=o>=</span>/bin/bash
</span></span><span class=line><span class=cl><span class=nv>pw_name</span><span class=o>=</span><span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=nv>pw_passwd</span><span class=o>=</span>x
</span></span><span class=line><span class=cl><span class=nv>pw_uid</span><span class=o>=</span><span class=m>1001</span>
</span></span><span class=line><span class=cl><span class=nv>pw_gid</span><span class=o>=</span><span class=m>1001</span>
</span></span><span class=line><span class=cl><span class=nv>pw_gecos</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>pw_dir</span><span class=o>=</span>/home/test
</span></span><span class=line><span class=cl><span class=nv>pw_shell</span><span class=o>=</span>/bin/bash
</span></span></code></pre></div><p>如果要查看整个口令文件，可以使用以下的函数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;pwd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>passwd</span><span class=o>*</span> <span class=nf>getpwent</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/* 成功返回指针，失败或到达文件为返回NULL */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>setpwent</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>endpwent</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span></code></pre></div><p>调用<code>getpwent</code>函数时，它返回口令文件的下一个记录项。</p><p>函数<code>setpwent</code>用来将<code>getpwent</code>的读写地址指向口令文件开头，<code>endpwent</code>则关闭口令文件。</p><p><strong><code>getpwuid</code>和<code>getpwnam</code>函数调用完之后也不应该使文件处于打开状态，应调用<code>endpwent</code>关闭文件。</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;pwd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>passwd</span><span class=o>*</span> <span class=n>pPWD</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>setpwent</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>((</span><span class=n>pPWD</span> <span class=o>=</span> <span class=nf>getpwent</span><span class=p>())</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pw_name=%s,&#34;</span><span class=p>,</span> <span class=n>pPWD</span><span class=o>-&gt;</span><span class=n>pw_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pw_passwd=%s,&#34;</span><span class=p>,</span> <span class=n>pPWD</span><span class=o>-&gt;</span><span class=n>pw_passwd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pw_uid=%d,&#34;</span><span class=p>,</span> <span class=n>pPWD</span><span class=o>-&gt;</span><span class=n>pw_uid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pw_gid=%d,&#34;</span><span class=p>,</span> <span class=n>pPWD</span><span class=o>-&gt;</span><span class=n>pw_gid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pw_gecos=%s,&#34;</span><span class=p>,</span> <span class=n>pPWD</span><span class=o>-&gt;</span><span class=n>pw_gecos</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pw_dir=%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pPWD</span><span class=o>-&gt;</span><span class=n>pw_dir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>endpwent</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>执行结果如下所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ./passwd_info_traverse
</span></span><span class=line><span class=cl><span class=nv>pw_name</span><span class=o>=</span>root,pw_passwd<span class=o>=</span>x,pw_uid<span class=o>=</span>0,pw_gid<span class=o>=</span>0,pw_gecos<span class=o>=</span>root,pw_dir<span class=o>=</span>/root
</span></span><span class=line><span class=cl><span class=nv>pw_name</span><span class=o>=</span>nobody,pw_passwd<span class=o>=</span>x,pw_uid<span class=o>=</span>65534,pw_gid<span class=o>=</span>65534,pw_gecos<span class=o>=</span>nobody,pw_dir<span class=o>=</span>/nonexistent
</span></span><span class=line><span class=cl><span class=nv>pw_name</span><span class=o>=</span>test,pw_passwd<span class=o>=</span>x,pw_uid<span class=o>=</span>1001,pw_gid<span class=o>=</span>1001,pw_gecos<span class=o>=</span>,pw_dir<span class=o>=</span>/home/test
</span></span><span class=line><span class=cl><span class=nv>pw_name</span><span class=o>=</span>sshd,pw_passwd<span class=o>=</span>x,pw_uid<span class=o>=</span>127,pw_gid<span class=o>=</span>65534,pw_gecos<span class=o>=</span>,pw_dir<span class=o>=</span>/run/sshd
</span></span></code></pre></div><h3 id=阴影口令><a href=#%e9%98%b4%e5%bd%b1%e5%8f%a3%e4%bb%a4>阴影口令</a></h3><p>加密口令是经过单向加密算法处理过的用户口令副本。加密算法有MD5、SHA-1、SHA-256、SHA-512等。</p><p>大部分系统将加密口令存放在另一个称为阴影口令的文件中，该文件中至少要包含用户名和加密口令。加密口令通常包含以下字段：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* A record in the shadow database.  */</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>spwd</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>*</span><span class=n>sp_namp</span><span class=p>;</span>              <span class=cm>/* Login name.  */</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>*</span><span class=n>sp_pwdp</span><span class=p>;</span>              <span class=cm>/* Hashed passphrase.  */</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=kt>int</span> <span class=n>sp_lstchg</span><span class=p>;</span>         <span class=cm>/* Date of last change.  */</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=kt>int</span> <span class=n>sp_min</span><span class=p>;</span>            <span class=cm>/* Minimum number of days between changes.  */</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=kt>int</span> <span class=n>sp_max</span><span class=p>;</span>            <span class=cm>/* Maximum number of days between changes.  */</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=kt>int</span> <span class=n>sp_warn</span><span class=p>;</span>           <span class=cm>/* Number of days to warn user to change
</span></span></span><span class=line><span class=cl><span class=cm>                                   the password.  */</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=kt>int</span> <span class=n>sp_inact</span><span class=p>;</span>          <span class=cm>/* Number of days the account may be
</span></span></span><span class=line><span class=cl><span class=cm>                                   inactive.  */</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=kt>int</span> <span class=n>sp_expire</span><span class=p>;</span>         <span class=cm>/* Number of days since 1970-01-01 until
</span></span></span><span class=line><span class=cl><span class=cm>                                   account expires.  */</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>int</span> <span class=n>sp_flag</span><span class=p>;</span>  <span class=cm>/* Reserved.  */</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span></code></pre></div><p>阴影口令文件不应是普通用户可以读取的。仅有少数几个程序需要访问加密口令，如<code>login</code>和<code>passwd</code>，这些程序通常设置用户为root。</p><p>有了阴影口令文件之后，普通口令文件<code>/etc/passwd</code>可由各用户自由读取。</p><p>与访问口令文件类似，有一组函数可用于阴影口令文件访问：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;shadow.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>spwd</span><span class=o>*</span> <span class=nf>getspnam</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>spwd</span><span class=o>*</span> <span class=nf>getspent</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>setspent</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>endspent</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span></code></pre></div><p>下面是该函数的使用范例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;shadow.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>spwd</span><span class=o>*</span> <span class=n>pSPWD</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>pSPWD</span> <span class=o>=</span> <span class=nf>getspnam</span><span class=p>(</span><span class=s>&#34;blduan&#34;</span><span class=p>))</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;sp_namp=%s, sp_pwdp=%s, sp_lstchg=%ld, sp_min=%ld, sp_max=%ld, &#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;sp_warn=%ld, sp_inact=%ld, sp_expire=%ld, sp_flag=%uld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>pSPWD</span><span class=o>-&gt;</span><span class=n>sp_namp</span><span class=p>,</span> <span class=n>pSPWD</span><span class=o>-&gt;</span><span class=n>sp_pwdp</span><span class=p>,</span> <span class=n>pSPWD</span><span class=o>-&gt;</span><span class=n>sp_lstchg</span><span class=p>,</span> <span class=n>pSPWD</span><span class=o>-&gt;</span><span class=n>sp_min</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>pSPWD</span><span class=o>-&gt;</span><span class=n>sp_max</span><span class=p>,</span> <span class=n>pSPWD</span><span class=o>-&gt;</span><span class=n>sp_warn</span><span class=p>,</span> <span class=n>pSPWD</span><span class=o>-&gt;</span><span class=n>sp_inact</span><span class=p>,</span> <span class=n>pSPWD</span><span class=o>-&gt;</span><span class=n>sp_expire</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>pSPWD</span><span class=o>-&gt;</span><span class=n>sp_flag</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;getspnam failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>setspent</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>((</span><span class=n>pSPWD</span> <span class=o>=</span> <span class=nf>getspent</span><span class=p>())</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;sp_namp=%s, sp_pwdp=%s, sp_lstchg=%ld, sp_min=%ld, sp_max=%ld, &#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;sp_warn=%ld, sp_inact=%ld, sp_expire=%ld, sp_flag=%uld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>pSPWD</span><span class=o>-&gt;</span><span class=n>sp_namp</span><span class=p>,</span> <span class=n>pSPWD</span><span class=o>-&gt;</span><span class=n>sp_pwdp</span><span class=p>,</span> <span class=n>pSPWD</span><span class=o>-&gt;</span><span class=n>sp_lstchg</span><span class=p>,</span> <span class=n>pSPWD</span><span class=o>-&gt;</span><span class=n>sp_min</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>pSPWD</span><span class=o>-&gt;</span><span class=n>sp_max</span><span class=p>,</span> <span class=n>pSPWD</span><span class=o>-&gt;</span><span class=n>sp_warn</span><span class=p>,</span> <span class=n>pSPWD</span><span class=o>-&gt;</span><span class=n>sp_inact</span><span class=p>,</span> <span class=n>pSPWD</span><span class=o>-&gt;</span><span class=n>sp_expire</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>pSPWD</span><span class=o>-&gt;</span><span class=n>sp_flag</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>endspent</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>执行结果如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ sudo ./shadow_passwd_info
</span></span><span class=line><span class=cl><span class=nv>sp_namp</span><span class=o>=</span>blduan, <span class=nv>sp_pwdp</span><span class=o>=</span><span class=nv>$1$jbKtX7HQ$LIC5WYIkWKu7Li</span>/YXRHAR., <span class=nv>sp_lstchg</span><span class=o>=</span>19035, <span class=nv>sp_min</span><span class=o>=</span>0, <span class=nv>sp_max</span><span class=o>=</span>99999, <span class=nv>sp_warn</span><span class=o>=</span>7, <span class=nv>sp_inact</span><span class=o>=</span>-1, <span class=nv>sp_expire</span><span class=o>=</span>-1, <span class=nv>sp_flag</span><span class=o>=</span>4294967295ld
</span></span><span class=line><span class=cl><span class=nv>sp_namp</span><span class=o>=</span>root, <span class=nv>sp_pwdp</span><span class=o>=</span>!, <span class=nv>sp_lstchg</span><span class=o>=</span>19035, <span class=nv>sp_min</span><span class=o>=</span>0, <span class=nv>sp_max</span><span class=o>=</span>99999, <span class=nv>sp_warn</span><span class=o>=</span>7, <span class=nv>sp_inact</span><span class=o>=</span>-1, <span class=nv>sp_expire</span><span class=o>=</span>-1, <span class=nv>sp_flag</span><span class=o>=</span>4294967295ld
</span></span><span class=line><span class=cl><span class=nv>sp_namp</span><span class=o>=</span>nobody, <span class=nv>sp_pwdp</span><span class=o>=</span>*, <span class=nv>sp_lstchg</span><span class=o>=</span>18858, <span class=nv>sp_min</span><span class=o>=</span>0, <span class=nv>sp_max</span><span class=o>=</span>99999, <span class=nv>sp_warn</span><span class=o>=</span>7, <span class=nv>sp_inact</span><span class=o>=</span>-1, <span class=nv>sp_expire</span><span class=o>=</span>-1, <span class=nv>sp_flag</span><span class=o>=</span>4294967295ld
</span></span><span class=line><span class=cl><span class=nv>sp_namp</span><span class=o>=</span>blduan, <span class=nv>sp_pwdp</span><span class=o>=</span><span class=nv>$1$jbKtX7HQ$LIC5WYIkWKu7Li</span>/YXRHAR., <span class=nv>sp_lstchg</span><span class=o>=</span>19035, <span class=nv>sp_min</span><span class=o>=</span>0, <span class=nv>sp_max</span><span class=o>=</span>99999, <span class=nv>sp_warn</span><span class=o>=</span>7, <span class=nv>sp_inact</span><span class=o>=</span>-1, <span class=nv>sp_expire</span><span class=o>=</span>-1, <span class=nv>sp_flag</span><span class=o>=</span>4294967295ld
</span></span><span class=line><span class=cl><span class=nv>sp_namp</span><span class=o>=</span>test, <span class=nv>sp_pwdp</span><span class=o>=</span><span class=nv>$6</span>$/yhfXl20IXzYXbTI<span class=nv>$HmJbYMd1uqXJQOut7W3J</span>/g5h3wM5s8lbo5HJaBsUZ3AOK6/kreFdVFwam7II6Qh0L7BlD0kZOIcSx7TvxIVxL., <span class=nv>sp_lstchg</span><span class=o>=</span>19058, <span class=nv>sp_min</span><span class=o>=</span>0, <span class=nv>sp_max</span><span class=o>=</span>99999, <span class=nv>sp_warn</span><span class=o>=</span>7, <span class=nv>sp_inact</span><span class=o>=</span>-1, <span class=nv>sp_expire</span><span class=o>=</span>-1, <span class=nv>sp_flag</span><span class=o>=</span>4294967295ld
</span></span></code></pre></div><h2 id=组><a href=#%e7%bb%84>组</a></h2><p>Linux用户能够属于两种类型的组，分别是主组（Primary or login group）和附属组（Secondary or supplementary group）。</p><p>主组主要用来在用户创建文件时来设置文件所属组的。主组名称通常和用户名一致，并且用户只能属于一个主组。</p><p>附属组主要用来给多个用户授予某种权限，用户可以属于0个或多个附属组。</p><p>用户的主组信息保存在口令文件<code>/etc/passwd</code>中，用户的附属组信息保存在组文件<code>/etc/group</code>中。</p><p><code>groups</code>命令可以罗列出当前用户的所有组信息。第一个是用户的主组。</p><p>Unix组文件主要包含4个字段，这些字段定义在<code>grp.h</code>头文件中，如下所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* The group structure.  */</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>group</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>*</span><span class=n>gr_name</span><span class=p>;</span>              <span class=cm>/* Group name.  */</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>*</span><span class=n>gr_passwd</span><span class=p>;</span>            <span class=cm>/* Password.    */</span>
</span></span><span class=line><span class=cl>    <span class=n>__gid_t</span> <span class=n>gr_gid</span><span class=p>;</span>             <span class=cm>/* Group ID.    */</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>**</span><span class=n>gr_mem</span><span class=p>;</span>              <span class=cm>/* Member list. */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p><code>gr_mem</code>是一个指针数组，每个指针指向属于该组的用户名。该数组以null指针结尾。</p><p>可以通过组名或组ID来获取组信息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;grp.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>group</span><span class=o>*</span> <span class=nf>getgrgid</span><span class=p>(</span><span class=kt>gid_t</span> <span class=n>gid</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>group</span><span class=o>*</span> <span class=nf>getgrnam</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/* 成功返回指针，失败返回NULL */</span>
</span></span></code></pre></div><p>上面两个函数和口令文件操作类似，都返回的是静态变量的指针，每次调用都会重写。</p><p>遍历整个组文件，可以使用下面3个函数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;grp.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>group</span><span class=o>*</span> <span class=nf>getgrent</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>setgrent</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>endgrent</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span></code></pre></div><p><code>setgrent</code>函数打开组文件，并将读位置置为文件开头。</p><p><code>getgrent</code>函数从组文件读取下一项，如果未打开，则先打开文件。</p><p><code>endgrent</code>函数关闭组文件。</p><p>下面是获取组信息的实例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;grp.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>group</span><span class=o>*</span> <span class=n>pGroup</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>pGroup</span> <span class=o>=</span> <span class=nf>getgrnam</span><span class=p>(</span><span class=s>&#34;sambashare&#34;</span><span class=p>))</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;gr_name=%s, gr_passwd=%s, gr_gid=%d, gr_mem=&#34;</span><span class=p>,</span> <span class=n>pGroup</span><span class=o>-&gt;</span><span class=n>gr_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>pGroup</span><span class=o>-&gt;</span><span class=n>gr_passwd</span><span class=p>,</span> <span class=n>pGroup</span><span class=o>-&gt;</span><span class=n>gr_gid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>pGroup</span><span class=o>-&gt;</span><span class=n>gr_mem</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s,&#34;</span><span class=p>,</span> <span class=n>pGroup</span><span class=o>-&gt;</span><span class=n>gr_mem</span><span class=p>[</span><span class=n>i</span><span class=o>++</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>endgrent</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>pGroup</span> <span class=o>=</span> <span class=nf>getgrgid</span><span class=p>(</span><span class=nf>getgid</span><span class=p>()))</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;gr_name=%s, gr_passwd=%s, gr_gid=%d, gr_mem=&#34;</span><span class=p>,</span> <span class=n>pGroup</span><span class=o>-&gt;</span><span class=n>gr_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>pGroup</span><span class=o>-&gt;</span><span class=n>gr_passwd</span><span class=p>,</span> <span class=n>pGroup</span><span class=o>-&gt;</span><span class=n>gr_gid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>pGroup</span><span class=o>-&gt;</span><span class=n>gr_mem</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s,&#34;</span><span class=p>,</span> <span class=n>pGroup</span><span class=o>-&gt;</span><span class=n>gr_mem</span><span class=p>[</span><span class=n>i</span><span class=o>++</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>endgrent</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>setgrent</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>((</span><span class=n>pGroup</span> <span class=o>=</span> <span class=nf>getgrent</span><span class=p>())</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;gr_name=%s, gr_passwd=%s, gr_gid=%d, gr_mem=&#34;</span><span class=p>,</span> <span class=n>pGroup</span><span class=o>-&gt;</span><span class=n>gr_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>pGroup</span><span class=o>-&gt;</span><span class=n>gr_passwd</span><span class=p>,</span> <span class=n>pGroup</span><span class=o>-&gt;</span><span class=n>gr_gid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>pGroup</span><span class=o>-&gt;</span><span class=n>gr_mem</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s,&#34;</span><span class=p>,</span> <span class=n>pGroup</span><span class=o>-&gt;</span><span class=n>gr_mem</span><span class=p>[</span><span class=n>i</span><span class=o>++</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>endgrent</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>执行结果如下所示：（节选部分结果）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ./grp_info
</span></span><span class=line><span class=cl><span class=nv>gr_name</span><span class=o>=</span>sambashare, <span class=nv>gr_passwd</span><span class=o>=</span>x, <span class=nv>gr_gid</span><span class=o>=</span>133, <span class=nv>gr_mem</span><span class=o>=</span>blduan,
</span></span><span class=line><span class=cl><span class=nv>gr_name</span><span class=o>=</span>blduan, <span class=nv>gr_passwd</span><span class=o>=</span>x, <span class=nv>gr_gid</span><span class=o>=</span>1000, <span class=nv>gr_mem</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>gr_name</span><span class=o>=</span>root, <span class=nv>gr_passwd</span><span class=o>=</span>x, <span class=nv>gr_gid</span><span class=o>=</span>0, <span class=nv>gr_mem</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>gr_name</span><span class=o>=</span>blduan, <span class=nv>gr_passwd</span><span class=o>=</span>x, <span class=nv>gr_gid</span><span class=o>=</span>1000, <span class=nv>gr_mem</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>gr_name</span><span class=o>=</span>sambashare, <span class=nv>gr_passwd</span><span class=o>=</span>x, <span class=nv>gr_gid</span><span class=o>=</span>133, <span class=nv>gr_mem</span><span class=o>=</span>blduan,
</span></span><span class=line><span class=cl><span class=nv>gr_name</span><span class=o>=</span>systemd-coredump, <span class=nv>gr_passwd</span><span class=o>=</span>x, <span class=nv>gr_gid</span><span class=o>=</span>999, <span class=nv>gr_mem</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>gr_name</span><span class=o>=</span>test, <span class=nv>gr_passwd</span><span class=o>=</span>x, <span class=nv>gr_gid</span><span class=o>=</span>1001, <span class=nv>gr_mem</span><span class=o>=</span>
</span></span></code></pre></div><h3 id=附属组><a href=#%e9%99%84%e5%b1%9e%e7%bb%84>附属组</a></h3><p>自从1983年引入附属组的概念之后，文件访问权限检查就被修改为：<strong>不仅将进程的有效组ID和文件的组ID相比较，也将所有附属组ID与文件的组ID进行比较。</strong></p><p>使用附属组的优点在于不用再显式地经常更改组。</p><p>下面几个函数用于获取和设置附属组：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>getgroups</span><span class=p>(</span><span class=kt>int</span> <span class=n>gidsize</span><span class=p>,</span> <span class=kt>gid_t</span> <span class=n>grouplist</span><span class=p>[]);</span>
</span></span><span class=line><span class=cl><span class=cm>/* 成功返回附属组ID数量，失败返回-1 */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;grp.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>setgroups</span><span class=p>(</span><span class=kt>int</span> <span class=n>ngroups</span><span class=p>,</span> <span class=k>const</span> <span class=kt>gid_t</span> <span class=n>grouplist</span><span class=p>[]);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>initgroups</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>username</span><span class=p>,</span> <span class=kt>gid_t</span> <span class=n>basegid</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/* 成功返回0， 失败返回-1 */</span>
</span></span></code></pre></div><p><code>getgroups</code>函数将进程所属用户的各附属组ID填写到数组<code>grouplist</code>中，填写个数最多是<code>gidsize</code>。实际填写到数组中的附属组ID个数由函数返回。如果<code>gidsize</code>为0，函数只返回附属组ID个数，对<code>grouplist</code>不做修改。</p><p><code>getgroups</code>函数相比<code>getgrnam</code>和<code>getgrgid</code>函数的区别在于，前者是获取当前进程所属用户的附属组ID，后者是根据组名或组ID获取组自身的信息。</p><p><code>setgroups</code>函数可有超级用户调用，以便为进程设置附属组ID表。<code>grouplist</code>是组ID数组，<code>ngroups</code>指的是组ID个数。<code>ngroups</code>不能超过<code>NGROUPS_MAX</code>。</p><p>通常只有<code>initgroups</code>函数调用<code>setgroups</code>，<code>initgroups</code>函数使用<code>setgrent, getgrent, endgrent</code>函数读取整个组文件，然后获取<code>username</code>的所有附属组，最后调用<code>setgroups</code>为用户初始化附属组ID表。</p><p>由于<code>initgroups</code>函数要调用<code>setgroups</code>，所以必须的超级用户权限（除了在组文件在找<code>username</code>的附属组）。</p><p><code>initgroups</code>也在附属组ID表中包含了<code>basegid</code>。<code>basegid</code>是<code>username</code>的主组ID，保存在口令文件中。</p><p>下面是这几个函数的测试用例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;grp.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Get supplentary groups size limits is %ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nf>sysconf</span><span class=p>(</span><span class=n>_SC_NGROUPS_MAX</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>gid_t</span> <span class=n>groupList</span><span class=p>[</span><span class=mi>32</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>supplentaryGrpNums</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;The effective group id of current proccess is %ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=nf>getegid</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* getgroups函数有时会返回进程的有效组ID */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>supplentaryGrpNums</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=nf>getgroups</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>groupList</span><span class=p>)</span> <span class=o>/</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>gid_t</span><span class=p>),</span> <span class=n>groupList</span><span class=p>))</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Current process owner&#39;s supplentary group ids are &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>supplentaryGrpNums</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%ld,&#34;</span><span class=p>,</span> <span class=n>groupList</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>Get supplentary groups size limits is 65536
</span></span></span><span class=line><span class=cl><span class=cm>The effective group id of current proccess is 1000
</span></span></span><span class=line><span class=cl><span class=cm>Current process owner&#39;s supplentary group ids are 4,24,27,30,46,120,132,133,1000,
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></div><h2 id=其他数据文件><a href=#%e5%85%b6%e4%bb%96%e6%95%b0%e6%8d%ae%e6%96%87%e4%bb%b6>其他数据文件</a></h2><p>Unix系统还使用了其他数据文件，例如记录网络服务器提供服务的数据文件<code>/etc/services</code>，记录协议信息的数据文件<code>/etc/protocols</code>，记录网络信息的数据文件<code>/etc/networks</code>。</p><p>访问这些数据文件的接口和口令文件、阴影文件以及组文件的接口类似。</p><p>一般情况下，对每个数据文件至少有3个函数。</p><ul><li>get函数：读取文件的下一个记录，如果文件没有打开，则会先打开文件。此函数通常返回一个指向结构的指针（结构保存在静态区）。到达文件尾返回空指针。</li><li>set函数：打开相应数据文件，重置文件位置为文件开头。</li><li>end函数：关闭相应数据文件。</li></ul><p>除了这3个函数之外，数据文件也会支持某种形式的键搜索。例如口令文件的<code>getpwuid</code>和<code>getpwnam</code>等。</p><table><thead><tr><th style=text-align:left>说明</th><th style=text-align:left>数据文件</th><th style=text-align:left>头文件</th><th style=text-align:left>结构</th><th style=text-align:left>附加的键搜索函数</th></tr></thead><tbody><tr><td style=text-align:left>口令</td><td style=text-align:left><code>/etc/passwd</code></td><td style=text-align:left><code>&lt;pwd.h></code></td><td style=text-align:left><code>passwd</code></td><td style=text-align:left><code>getpwnam, getpwuid</code></td></tr><tr><td style=text-align:left>组</td><td style=text-align:left><code>/etc/group</code></td><td style=text-align:left><code>&lt;grp.h></code></td><td style=text-align:left><code>group</code></td><td style=text-align:left><code>getgrnam, getgrgid</code></td></tr><tr><td style=text-align:left>阴影</td><td style=text-align:left><code>/etc/shadow</code></td><td style=text-align:left><code>&lt;shadow.h></code></td><td style=text-align:left><code>spwd</code></td><td style=text-align:left><code>getspnam</code></td></tr><tr><td style=text-align:left>主机</td><td style=text-align:left><code>/etc/hosts</code></td><td style=text-align:left><code>&lt;netdb.h></code></td><td style=text-align:left><code>hostent</code></td><td style=text-align:left><code>getnameinfo, getaddinfo</code></td></tr><tr><td style=text-align:left>网络</td><td style=text-align:left><code>/etc/networks</code></td><td style=text-align:left><code>&lt;netdb.h></code></td><td style=text-align:left><code>netent</code></td><td style=text-align:left><code>getnetbyname, getnetbyaddr</code></td></tr><tr><td style=text-align:left>协议</td><td style=text-align:left><code>/etc/protocols</code></td><td style=text-align:left><code>&lt;netdb.h></code></td><td style=text-align:left><code>protoent</code></td><td style=text-align:left><code>getprotobyname, getprotobynumber</code></td></tr><tr><td style=text-align:left>服务</td><td style=text-align:left><code>/etc/services</code></td><td style=text-align:left><code>&lt;netdb.h></code></td><td style=text-align:left><code>servent</code></td><td style=text-align:left><code>getservbyname, getservbyport</code></td></tr></tbody></table><h2 id=登录账户><a href=#%e7%99%bb%e5%bd%95%e8%b4%a6%e6%88%b7>登录账户</a></h2><p>大多数Unix系统都提供两个数文件：</p><p><code>/var/run/utmp</code>文件记录当前登录到系统的各个用户。</p><p><code>/var/log/wtmp</code>文件跟踪各个登录和注销事件。</p><p>上面两个文件保存的是多条<code>struct utmp</code>结构体的记录，是二进制文件，不允许其他用户写。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* Values for ut_type field, below */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define EMPTY         0 </span><span class=cm>/* Record does not contain valid info
</span></span></span><span class=line><span class=cl><span class=cm>                            (formerly known as UT_UNKNOWN on Linux) */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#define RUN_LVL       1 </span><span class=cm>/* Change in system run-level (see
</span></span></span><span class=line><span class=cl><span class=cm>                            init(8)) */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#define BOOT_TIME     2 </span><span class=cm>/* Time of system boot (in ut_tv) */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#define NEW_TIME      3 </span><span class=cm>/* Time after system clock change
</span></span></span><span class=line><span class=cl><span class=cm>                            (in ut_tv) */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#define OLD_TIME      4 </span><span class=cm>/* Time before system clock change
</span></span></span><span class=line><span class=cl><span class=cm>                            (in ut_tv) */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#define INIT_PROCESS  5 </span><span class=cm>/* Process spawned by init(8) */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#define LOGIN_PROCESS 6 </span><span class=cm>/* Session leader process for user login */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#define USER_PROCESS  7 </span><span class=cm>/* Normal process */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#define DEAD_PROCESS  8 </span><span class=cm>/* Terminated process */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#define ACCOUNTING    9 </span><span class=cm>/* Not implemented */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define UT_LINESIZE      32
</span></span></span><span class=line><span class=cl><span class=cp>#define UT_NAMESIZE      32
</span></span></span><span class=line><span class=cl><span class=cp>#define UT_HOSTSIZE     256
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>exit_status</span> <span class=p>{</span>              <span class=cm>/* Type for ut_exit, below */</span>
</span></span><span class=line><span class=cl>    <span class=kt>short</span> <span class=kt>int</span> <span class=n>e_termination</span><span class=p>;</span>      <span class=cm>/* Process termination status */</span>
</span></span><span class=line><span class=cl>    <span class=kt>short</span> <span class=kt>int</span> <span class=n>e_exit</span><span class=p>;</span>             <span class=cm>/* Process exit status */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=cm>/* The structure describing an entry in the user accounting database.  */</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>utmp</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>short</span> <span class=n>ut_type</span><span class=p>;</span>              <span class=cm>/* Type of record */</span>
</span></span><span class=line><span class=cl>    <span class=kt>pid_t</span> <span class=n>ut_pid</span><span class=p>;</span>               <span class=cm>/* PID of login process */</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>ut_line</span><span class=p>[</span><span class=n>UT_LINESIZE</span><span class=p>];</span>  <span class=cm>/* Device name of tty - &#34;/dev/&#34; */</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>ut_id</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>              <span class=cm>/* Terminal name suffix,
</span></span></span><span class=line><span class=cl><span class=cm>                                   or inittab(5) ID */</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>ut_user</span><span class=p>[</span><span class=n>UT_NAMESIZE</span><span class=p>];</span>  <span class=cm>/* Username */</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>ut_host</span><span class=p>[</span><span class=n>UT_HOSTSIZE</span><span class=p>];</span>  <span class=cm>/* Hostname for remote login, or
</span></span></span><span class=line><span class=cl><span class=cm>                                   kernel version for run-level
</span></span></span><span class=line><span class=cl><span class=cm>                                   messages */</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>exit_status</span> <span class=n>ut_exit</span><span class=p>;</span> <span class=cm>/* Exit status of a process
</span></span></span><span class=line><span class=cl><span class=cm>                                   marked as DEAD_PROCESS; not
</span></span></span><span class=line><span class=cl><span class=cm>                                   used by Linux init (1 */</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* The ut_session and ut_tv fields must be the same size when
</span></span></span><span class=line><span class=cl><span class=cm>       compiled 32- and 64-bit.  This allows data files and shared
</span></span></span><span class=line><span class=cl><span class=cm>       memory to be shared between 32- and 64-bit applications. */</span>
</span></span><span class=line><span class=cl><span class=cp>#if __WORDSIZE == 64 &amp;&amp; defined __WORDSIZE_COMPAT32
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=kt>int32_t</span> <span class=n>ut_session</span><span class=p>;</span> <span class=cm>/* Session ID (getsid(2)),
</span></span></span><span class=line><span class=cl><span class=cm>                           used for windowing */</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int32_t</span> <span class=n>tv_sec</span><span class=p>;</span>  <span class=cm>/* Seconds */</span>
</span></span><span class=line><span class=cl>        <span class=kt>int32_t</span> <span class=n>tv_usec</span><span class=p>;</span> <span class=cm>/* Microseconds */</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>ut_tv</span><span class=p>;</span>             <span class=cm>/* Time entry was made */</span>
</span></span><span class=line><span class=cl><span class=cp>#else
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=kt>long</span> <span class=n>ut_session</span><span class=p>;</span>      <span class=cm>/* Session ID */</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>timeval</span> <span class=n>ut_tv</span><span class=p>;</span> <span class=cm>/* Time entry was made */</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>    <span class=kt>int32_t</span> <span class=n>ut_addr_v6</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span> <span class=cm>/* Internet address of remote
</span></span></span><span class=line><span class=cl><span class=cm>                              host; IPv4 address uses
</span></span></span><span class=line><span class=cl><span class=cm>                              just ut_addr_v6[0] */</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>__unused</span><span class=p>[</span><span class=mi>20</span><span class=p>];</span>     <span class=cm>/* Reserved for future use */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>登录时，<code>login</code>进程会生成<code>utmp</code>结构，并将内容先后写到<code>/var/run/utmp</code>和<code>/var/log/wtmp</code>文件中。注销时，<code>init</code>进程会从<code>/var/run/utmp</code>文件中删除相应记录，并添加新纪录到<code>/var/log/wtmp</code>文件中。</p><p><code>who</code>命令可以读取<code>/var/run/utmp</code>文件，<code>last</code>命令可以读取<code>/var/log/wtmp</code>文件。</p><p>下面是一个who命令自实现版本：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c></code></pre></div><h2 id=系统标识><a href=#%e7%b3%bb%e7%bb%9f%e6%a0%87%e8%af%86>系统标识</a></h2><p>POSIX.1定义了<code>uname</code>函数，返回与主机和操作系统相关的信息。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/utsname.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>uname</span><span class=p>(</span><span class=k>struct</span> <span class=n>utsname</span><span class=o>*</span> <span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/* 成功返回0 失败返回-1 */</span>
</span></span></code></pre></div><p>函数填写填入的<code>utsname</code>结构。POSIX.1定义该结构必须的字段，字段的长度有具体实现定义。下面是glibc中的实现：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* Length of the entries in `struct utsname&#39; is 65.  */</span>
</span></span><span class=line><span class=cl><span class=cp>#define _UTSNAME_LENGTH 65
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#ifndef _UTSNAME_SYSNAME_LENGTH
</span></span></span><span class=line><span class=cl><span class=cp># define _UTSNAME_SYSNAME_LENGTH _UTSNAME_LENGTH
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp>#ifndef _UTSNAME_NODENAME_LENGTH
</span></span></span><span class=line><span class=cl><span class=cp># define _UTSNAME_NODENAME_LENGTH _UTSNAME_LENGTH
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp>#ifndef _UTSNAME_RELEASE_LENGTH
</span></span></span><span class=line><span class=cl><span class=cp># define _UTSNAME_RELEASE_LENGTH _UTSNAME_LENGTH
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp>#ifndef _UTSNAME_VERSION_LENGTH
</span></span></span><span class=line><span class=cl><span class=cp># define _UTSNAME_VERSION_LENGTH _UTSNAME_LENGTH
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp>#ifndef _UTSNAME_MACHINE_LENGTH
</span></span></span><span class=line><span class=cl><span class=cp># define _UTSNAME_MACHINE_LENGTH _UTSNAME_LENGTH
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=cm>/* Structure describing the system and machine.  */</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>utsname</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* Name of the implementation of the operating system.  */</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>sysname</span><span class=p>[</span><span class=n>_UTSNAME_SYSNAME_LENGTH</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Name of this node on the network.  */</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>nodename</span><span class=p>[</span><span class=n>_UTSNAME_NODENAME_LENGTH</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Current release level of this implementation.  */</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>release</span><span class=p>[</span><span class=n>_UTSNAME_RELEASE_LENGTH</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* Current version level of this release.  */</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>version</span><span class=p>[</span><span class=n>_UTSNAME_VERSION_LENGTH</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Name of the hardware type the system is running on.  */</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>machine</span><span class=p>[</span><span class=n>_UTSNAME_MACHINE_LENGTH</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#if _UTSNAME_DOMAIN_LENGTH - 0
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=cm>/* Name of the domain of this node on the network.  */</span>
</span></span><span class=line><span class=cl><span class=cp># ifdef __USE_GNU
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=kt>char</span> <span class=n>domainname</span><span class=p>[</span><span class=n>_UTSNAME_DOMAIN_LENGTH</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=cp># else
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=kt>char</span> <span class=n>__domainname</span><span class=p>[</span><span class=n>_UTSNAME_DOMAIN_LENGTH</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=cp># endif
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=p>};</span>
</span></span></code></pre></div><p>其中<code>nodename</code>用于早期的UUCP网络，并不适用于现在的TCP网络。在使用该结构之前需要使用<code>sysconf</code>和<code>_SC_VERSION</code>判断POSIX的版本号。</p><p>为了获取网络主机名，可以使用<code>gethostname</code>函数代替。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>gethostname</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>name</span><span class=p>,</span> <span class=kt>int</span> <span class=n>namelen</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/*成功返回0 失败返回-1*/</span>
</span></span></code></pre></div><p>POSIX.1规定最大主机名长度为HOST_NAME_MAX。</p><p>下面是uname函数的用法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/utsname.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>sysconf</span><span class=p>(</span><span class=n>_SC_VERSION</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>200112L</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>struct</span> <span class=n>utsname</span> <span class=n>utsnameInfo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>uname</span><span class=p>(</span><span class=o>&amp;</span><span class=n>utsnameInfo</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;uname error:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;sysname=%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>utsnameInfo</span><span class=p>.</span><span class=n>sysname</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;nodename=%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>utsnameInfo</span><span class=p>.</span><span class=n>nodename</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;release=%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>utsnameInfo</span><span class=p>.</span><span class=n>release</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;version=%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>utsnameInfo</span><span class=p>.</span><span class=n>version</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;machine=%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>utsnameInfo</span><span class=p>.</span><span class=n>machine</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>char</span> <span class=n>hostname</span><span class=p>[</span><span class=mi>256</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>gethostname</span><span class=p>(</span><span class=n>hostname</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>hostname</span><span class=p>))</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;gethostname error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;hostname=%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>hostname</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>sysname=Linux
</span></span></span><span class=line><span class=cl><span class=cm>nodename=ubuntu
</span></span></span><span class=line><span class=cl><span class=cm>release=5.13.0-39-generic
</span></span></span><span class=line><span class=cl><span class=cm>version=#44~20.04.1-Ubuntu SMP Thu Mar 24 16:43:35 UTC 2022
</span></span></span><span class=line><span class=cl><span class=cm>machine=x86_64
</span></span></span><span class=line><span class=cl><span class=cm>hostname=ubuntu
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></div><h2 id=时间><a href=#%e6%97%b6%e9%97%b4>时间</a></h2><p>秒：铯-133原子在不受干扰的情况下，原子跃迁频率很稳定，因此将其跃迁9 192 631 770个周期所用的时间定义为一秒。</p><p>GMT：也称格林威治时间，天文时，GMT。是指位于英国伦敦郊区的皇家格林尼治天文台当地的平太阳时，因为本初子午线被定义为通过那里的经线。时区概念就指的是以本初子午线为基准的。</p><p>UTC：协调世界时，现在世界标准时间。指的是原子时和天文时协调之后的时间，由于地球气候变化、地球自转的影响，会导致天文时比原子时慢，每当两者相差0.9s时，就会将UTC协调时变慢1s，这就是闰秒的由来。具体数值是自1970年1月1日00:00:00以来经过的秒数。</p><p>时区：从格林威治本初子午线起，经度每向东或者向西间隔15°，就划分一个时区，在这个区域内，大家使用同样的标准时间。</p><p>Unix系统采用UTC而非本地时间作为系统时间，并且将时间和日期作为一个量值来保存。</p><h3 id=结构体><a href=#%e7%bb%93%e6%9e%84%e4%bd%93>结构体</a></h3><p>保存时间的几个数据结构<code>time_t, timespec, timeval</code>，具有不同的时间精度，从高到低分别是：</p><p><code>time_t</code>等同于<code>long int</code>，因此在32位机器上是32byte，64位机器上是64bits。</p><p><code>time_val</code>的时间精度为微秒。<code>gettimeofday</code>和<code>settimeofday</code>可用来获取该结构。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>timeval</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>time_t</span> <span class=n>tv_sec</span><span class=p>;</span> <span class=c1>// 秒
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>long</span> <span class=n>tv_usec</span><span class=p>;</span> <span class=c1>// 微秒
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p><code>timespec</code>的时间精度为纳秒。系统始终获取时间精度高，<code>clock_gettime</code>会将获取到的时间信息保存在<code>timespec</code>结构中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>timespac</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>time_t</span> <span class=n>tv_sec</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>tv_nsec</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=获取和设置><a href=#%e8%8e%b7%e5%8f%96%e5%92%8c%e8%ae%be%e7%bd%ae>获取和设置</a></h3><p>常规获取时间的函数有：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;time.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>time_t</span> <span class=nf>time</span><span class=p>(</span><span class=kt>time_t</span><span class=o>*</span> <span class=n>calptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/* 成功返回时间值，失败返回-1 */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/time.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>gettimeofday</span><span class=p>(</span><span class=k>struct</span> <span class=n>timeval</span><span class=o>*</span> <span class=n>tp</span><span class=p>,</span> <span class=kt>void</span><span class=o>*</span> <span class=n>tzp</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/* 返回值总是0 */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>clock_gettime</span><span class=p>(</span><span class=kt>clockid_t</span> <span class=n>clock_id</span><span class=p>,</span> <span class=k>struct</span> <span class=n>timespec</span> <span class=o>*</span><span class=n>tsp</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>clock_getres</span><span class=p>(</span><span class=kt>clockid_t</span> <span class=n>clock_id</span><span class=p>,</span> <span class=k>struct</span> <span class=n>timespec</span> <span class=o>*</span><span class=n>tsp</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>clock_settime</span><span class=p>(</span><span class=kt>clockid_t</span> <span class=n>clock_id</span><span class=p>,</span> <span class=k>const</span> <span class=k>struct</span> <span class=n>timespec</span> <span class=o>*</span><span class=n>tsp</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/* 成功返回0， 失败返回-1 */</span>
</span></span></code></pre></div><p>上面的函数分别获取时间精度从低到高的时间值。</p><p>其中<code>clock_id</code>的取值主要有<code>CLOCK_REALTIME, CLOCK_MONOTONIC, CLOCK_PROCESS_CPUTIME_ID, CLOCK_THREAD_CPUTIME_ID</code>。</p><p><code>clock_gettime</code>函数用于获取指定时钟的时间，返回的时间保存在<code>timespec</code>结构体中。<code>clock_getres</code>获取时间精度，默认为1纳秒。</p><p><code>gettimeofday</code>函数以距1970年1月1日00:00:00的秒数将当前时间存放在<code>tp</code>结构体中。其中<code>tsp</code>参数总是NULL。（建议不要使用该函数，无法通过返回值判断函数执行结果）。</p><p>下面是三中函数的使用范例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/time.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;time.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;sizeof(time_t)=%lu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>time_t</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>time_t</span> <span class=n>tNow</span> <span class=o>=</span> <span class=nf>time</span><span class=p>(</span><span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;tNow=%lu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>tNow</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* struct timeval tVal; */</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>timespec</span> <span class=n>timeSP</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>clock_gettime</span><span class=p>(</span><span class=n>CLOCK_REALTIME</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>timeSP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;tv_sec=%lu, tv_nsec=%ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>timeSP</span><span class=p>.</span><span class=n>tv_sec</span><span class=p>,</span> <span class=n>timeSP</span><span class=p>.</span><span class=n>tv_nsec</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>clock_gettime</span><span class=p>(</span><span class=n>CLOCK_PROCESS_CPUTIME_ID</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>timeSP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;tv_sec=%lu, tv_nsec=%ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>timeSP</span><span class=p>.</span><span class=n>tv_sec</span><span class=p>,</span> <span class=n>timeSP</span><span class=p>.</span><span class=n>tv_nsec</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>timespec</span> <span class=n>timeRes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>clock_getres</span><span class=p>(</span><span class=n>CLOCK_REALTIME</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>timeRes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;tv_sec=%lu, tv_nsec=%ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>timeRes</span><span class=p>.</span><span class=n>tv_sec</span><span class=p>,</span> <span class=n>timeRes</span><span class=p>.</span><span class=n>tv_nsec</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>timeval</span> <span class=n>timeV</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>gettimeofday</span><span class=p>(</span><span class=o>&amp;</span><span class=n>timeV</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;tv_sec=%lu, tv_usec=%ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>timeV</span><span class=p>.</span><span class=n>tv_sec</span><span class=p>,</span> <span class=n>timeV</span><span class=p>.</span><span class=n>tv_usec</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>执行结果如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ./time_info
</span></span><span class=line><span class=cl>sizeof<span class=o>(</span>time_t<span class=o>)=</span><span class=m>8</span>
</span></span><span class=line><span class=cl><span class=nv>tNow</span><span class=o>=</span><span class=m>1650464876</span>
</span></span><span class=line><span class=cl><span class=nv>tv_sec</span><span class=o>=</span>1650464876, <span class=nv>tv_nsec</span><span class=o>=</span><span class=m>715839889</span>
</span></span><span class=line><span class=cl><span class=nv>tv_sec</span><span class=o>=</span>0, <span class=nv>tv_nsec</span><span class=o>=</span><span class=m>750579</span>
</span></span><span class=line><span class=cl><span class=nv>tv_sec</span><span class=o>=</span>0, <span class=nv>tv_nsec</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nv>tv_sec</span><span class=o>=</span>1650464876, <span class=nv>tv_usec</span><span class=o>=</span><span class=m>715847</span>
</span></span></code></pre></div><h3 id=时区和格式化><a href=#%e6%97%b6%e5%8c%ba%e5%92%8c%e6%a0%bc%e5%bc%8f%e5%8c%96>时区和格式化</a></h3><p>时间除了上面的采用3中结构体表示经过的秒数之外，还有经过分解的时间结构如下所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;time.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>struct</span> <span class=n>tm</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>tm_sec</span><span class=p>;</span> <span class=cm>/* 0-60 瑞秒*/</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>tm_min</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>tm_hour</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>tm_mday</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>tm_mon</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>tm_year</span><span class=p>;</span> <span class=cm>/* 当前年份-1900 */</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>tm_wday</span><span class=p>;</span> <span class=cm>/* 每周的日期，取值0-6 */</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>tm_yday</span><span class=p>;</span> <span class=cm>/* 0-365 */</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>tm_isdst</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=nf>asctime</span><span class=p>(</span><span class=k>const</span> <span class=k>struct</span> <span class=n>tm</span> <span class=o>*</span><span class=n>tm</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=nf>asctime_r</span><span class=p>(</span><span class=k>const</span> <span class=k>struct</span> <span class=n>tm</span> <span class=o>*</span><span class=n>tm</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=nf>ctime</span><span class=p>(</span><span class=k>const</span> <span class=kt>time_t</span> <span class=o>*</span><span class=n>timep</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=nf>ctime_r</span><span class=p>(</span><span class=k>const</span> <span class=kt>time_t</span> <span class=o>*</span><span class=n>timep</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>tm</span> <span class=o>*</span><span class=nf>gmtime</span><span class=p>(</span><span class=k>const</span> <span class=kt>time_t</span> <span class=o>*</span><span class=n>timep</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>tm</span> <span class=o>*</span><span class=nf>gmtime_r</span><span class=p>(</span><span class=k>const</span> <span class=kt>time_t</span> <span class=o>*</span><span class=n>timep</span><span class=p>,</span> <span class=k>struct</span> <span class=n>tm</span> <span class=o>*</span><span class=n>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>tm</span> <span class=o>*</span><span class=nf>localtime</span><span class=p>(</span><span class=k>const</span> <span class=kt>time_t</span> <span class=o>*</span><span class=n>timep</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>tm</span> <span class=o>*</span><span class=nf>localtime_r</span><span class=p>(</span><span class=k>const</span> <span class=kt>time_t</span> <span class=o>*</span><span class=n>timep</span><span class=p>,</span> <span class=k>struct</span> <span class=n>tm</span> <span class=o>*</span><span class=n>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>time_t</span> <span class=nf>mktime</span><span class=p>(</span><span class=k>struct</span> <span class=n>tm</span> <span class=o>*</span><span class=n>tm</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>size_t</span> <span class=nf>strftime</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>s</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>max</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>format</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>struct</span> <span class=n>tm</span> <span class=o>*</span><span class=n>tm</span><span class=p>);</span>
</span></span></code></pre></div><p><code>asctime</code>函数将<code>tm</code>指向的时间结构体转换为字符串格式的时间。时区和<code>tm</code>表示的值对应。</p><p><code>ctime</code>函数将<code>time_t</code>表示的秒数转换为字符串形式的本地时间，和系统时区有关。</p><p><code>gmtime</code>函数将<code>time_t</code>表示的秒数转换为<code>tm</code>格式的UTC时间，时区默认为0.</p><p><code>localtime</code>函数将<code>time_t</code>表示的秒数转换为<code>tm</code>格式的本地时间。</p><p><code>mktime</code>以本地时间的<code>tm</code>结构形式转换为<code>time_t</code>值。</p><p><code>strftime</code>函数将<code>tm</code>结构体表示的时间转为<code>format</code>指定的格式。</p><p>格式说明如下：</p><table><thead><tr><th style=text-align:left>格式</th><th style=text-align:left>说明</th><th style=text-align:left>示例</th></tr></thead><tbody><tr><td style=text-align:left>%F</td><td style=text-align:left>YYYY-MM-DD</td><td style=text-align:left>2022-04-23</td></tr><tr><td style=text-align:left>%T</td><td style=text-align:left>%H:%M:%S</td><td style=text-align:left>10:57:23</td></tr></tbody></table><p>下面是这些函数的使用示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/time.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;time.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>time_t</span> <span class=n>tNow</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>time</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tNow</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%lu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>tNow</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>tm</span> <span class=n>gmt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>tm</span> <span class=n>lt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>gmtime_r</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tNow</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>gmt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>localtime_r</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tNow</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>lt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%d--%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>gmt</span><span class=p>.</span><span class=n>tm_hour</span><span class=p>,</span> <span class=n>lt</span><span class=p>.</span><span class=n>tm_hour</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>256</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nf>asctime_r</span><span class=p>(</span><span class=o>&amp;</span><span class=n>gmt</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;asctime gmt=%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>asctime_r</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lt</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;asctime lt=%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>ctime_r</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tNow</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;ctime=%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>time_t</span> <span class=n>tVal</span> <span class=o>=</span> <span class=nf>mktime</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%lu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>tVal</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>strftime</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>),</span> <span class=s>&#34;%F %T&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>lt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>执行结果如下所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ./time_format
</span></span><span class=line><span class=cl><span class=m>1650682356</span>
</span></span><span class=line><span class=cl>2--10
</span></span><span class=line><span class=cl>asctime <span class=nv>gmt</span><span class=o>=</span>Sat Apr <span class=m>23</span> 02:52:36 <span class=m>2022</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>asctime <span class=nv>lt</span><span class=o>=</span>Sat Apr <span class=m>23</span> 10:52:36 <span class=m>2022</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>ctime</span><span class=o>=</span>Sat Apr <span class=m>23</span> 10:52:36 <span class=m>2022</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>1650682356</span>
</span></span><span class=line><span class=cl>2022-04-23 10:58:34
</span></span></code></pre></div></div><div class=post-archive><ul class=post-copyright><li><strong>原文作者：</strong><a rel=author href=https://DBL2017.github.io/>生如夏花</a></li><li style=word-break:break-all><strong>原文链接：</strong><a href=https://DBL2017.github.io/post/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/apue/%E7%B3%BB%E7%BB%9F%E6%95%B0%E6%8D%AE%E6%96%87%E4%BB%B6%E5%92%8C%E4%BF%A1%E6%81%AF/>https://DBL2017.github.io/post/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/apue/%E7%B3%BB%E7%BB%9F%E6%95%B0%E6%8D%AE%E6%96%87%E4%BB%B6%E5%92%8C%E4%BF%A1%E6%81%AF/</a></li><li><strong>版权声明：</strong>本作品采用<a rel=license href=https://creativecommons.org/licenses/by-nc-nd/4.0/>知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li></ul></div><br><div class=post-archive><h2>相关文章</h2><ul class=listing><li><a href=/post/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/apue/%E6%A0%87%E5%87%86io/>标准IO</a></li><li><a href=/post/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/apue/%E6%96%87%E4%BB%B6io/>文件IO</a></li><li><a href=/post/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/apue/%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95/>文件和目录</a></li></ul></div><div class="post-meta meta-tags"><ul class=clearfix><li><a href=/tags/apue>APUE</a></li><li><a href=/tags/unix%E7%8E%AF%E5%A2%83%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B>Unix环境高级编程</a></li><li><a href=/tags/%E9%98%B4%E5%BD%B1%E5%8F%A3%E4%BB%A4>阴影口令</a></li><li><a href=/tags/shadow>shadow</a></li><li><a href=/tags/timeval>timeval</a></li><li><a href=/tags/time_t>time_t</a></li><li><a href=/tags/%E6%97%B6%E9%92%9F>时钟</a></li><li><a href=/tags/group>group</a></li></ul></div></article><div class="post bg-white"><script src=https://utteranc.es/client.js repo=DBL2017/DBL2017.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></div></div><div class=content-right><div class=sidebar><section class=widget><form id=form-search action=https://DBL2017.github.io/search/ method=get accept-charset=utf-8 _lpchecked=1><input type=text name=q maxlength=20 placeholder=请输入查找关键字 required>
<button type=submit class=submit title=提交>
<svg t="1714448321870" class="icon" style="width:22px;height:22px" viewBox="0 0 1024 1024" p-id="1771" width="200" height="200"><path d="M781.9264 691.1232l236.928 236.9216-90.816 90.8032-236.9152-236.9216c-72.032 53.3568-161.184 84.9088-257.7088 84.9088C194.048 866.8352.0 672.7872.0 433.408.0 194.048 194.048.0 433.4144.0c239.3728.0 433.4208 194.048 433.4208 433.4144.0 96.5248-31.552 185.6768-84.9088 257.7088zm-348.512 47.2896c168.448.0 304.9984-136.5504 304.9984-304.9984s-136.5504-304.992-304.9984-304.992-304.992 136.5504-304.992 304.9856c0 168.448 136.5504 304.9984 304.992 304.9984z" fill="#4A4A4A" p-id="1772"/></svg></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=https://DBL2017.github.io/post/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/windowsterminal%E9%85%8D%E7%BD%AE/ title=WindowsTerminal配置>WindowsTerminal配置</a></li><li><a href=https://DBL2017.github.io/post/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E5%BF%98%E8%AE%B0ubuntu14.04%E7%9A%84%E7%99%BB%E5%BD%95%E8%B4%A6%E5%AF%86%E7%9A%84%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F/ title=记录一次忘记Ubuntu14.04的登录账密的处理方式>记录一次忘记Ubuntu14.04的登录账密的处理方式</a></li><li><a href=https://DBL2017.github.io/post/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91/neovim/diagnostic/ title=Diagnostic>Diagnostic</a></li><li><a href=https://DBL2017.github.io/post/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/openwrt/libubox/uloop%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/ title=uloop源码剖析>uloop源码剖析</a></li><li><a href=https://DBL2017.github.io/post/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/latex/tikz%E7%BB%98%E5%88%B6%E6%8A%98%E7%BA%BF%E5%9B%BE/ title=TiKZ绘制折线图>TiKZ绘制折线图</a></li><li><a href=https://DBL2017.github.io/post/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/ubuntu18%E6%B0%B8%E4%B9%85%E4%BF%AE%E6%94%B9%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3%E5%90%8D%E7%A7%B0/ title=Ubuntu18永久修改网络接口名称>Ubuntu18永久修改网络接口名称</a></li><li><a href=https://DBL2017.github.io/post/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/latex/latex%E4%B9%8Bdocumentclass/ title=LaTeX之documentclass>LaTeX之documentclass</a></li><li><a href=https://DBL2017.github.io/post/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/latex/latex%E4%B9%8Bctex%E5%AE%8F%E9%9B%86%E4%B9%8B%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3%E7%B1%BB/ title=LaTeX之CTeX宏集之中文文档类>LaTeX之CTeX宏集之中文文档类</a></li><li><a href=https://DBL2017.github.io/post/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/latex/latex%E4%B9%8B%E4%B8%AD%E6%96%87%E6%94%AF%E6%8C%81/ title=LaTex之中文支持>LaTex之中文支持</a></li><li><a href=https://DBL2017.github.io/post/%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE/dibbler-server%E7%9A%84dhcpv6-pd%E5%A6%82%E4%BD%95%E5%88%86%E9%85%8D56%E4%BD%8D%E5%89%8D%E7%BC%80/ title=dibbler-server的DHCPv6-PD如何分配56位前缀>dibbler-server的DHCPv6-PD如何分配56位前缀</a></li></ul></section><section class=widget><h3 class=widget-title><a href=/categories/>分类</a></h3><ul class=widget-list><li><a href=https://DBL2017.github.io/categories/%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE/>传输协议 (17)</a></li><li><a href=https://DBL2017.github.io/categories/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/>工具使用 (25)</a></li><li><a href=https://DBL2017.github.io/categories/%E5%BC%80%E6%BA%90%E4%B8%89%E6%96%B9/>开源三方 (2)</a></li><li><a href=https://DBL2017.github.io/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/>操作系统 (14)</a></li><li><a href=https://DBL2017.github.io/categories/%E6%95%B0%E5%AD%97%E5%AE%89%E5%85%A8/>数字安全 (4)</a></li><li><a href=https://DBL2017.github.io/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/>数据结构和算法 (5)</a></li><li><a href=https://DBL2017.github.io/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/>编程语言 (14)</a></li><li><a href=https://DBL2017.github.io/categories/%E7%BD%91%E7%BB%9C%E5%B7%A5%E7%A8%8B%E5%B8%88/>网络工程师 (4)</a></li><li><a href=https://DBL2017.github.io/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/>读书笔记 (56)</a></li><li><a href=https://DBL2017.github.io/categories/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/>问题排查 (6)</a></li><li><a href=https://DBL2017.github.io/categories/%E9%BB%98%E8%AE%A4/>默认 (2)</a></li></ul></section><section class=widget><h3 class=widget-title>友情链接</h3><ul class=widget-list><li><a target=_blank href=https://mermaid.live/ title=Mermaid>Mermaid 编辑</a></li><li><a target=_blank href=https://excalidraw.com/ title=EXCALIDRAW>Excalidraw 绘图</a></li><li><a target=_blank href=https://git-scm.com/docs title=Git命令参考手册>Git命令参考手册</a></li><li><a target=_blank href=https://www.gnu.org/software/make/manual/make.html title="GNU make官方文档">GNU make官方文档</a></li><li><a target=_blank href=https://www.emojiall.com/ title=Emojiall表情网站>Emojiall表情网站</a></li></ul></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=https://DBL2017.github.io/index.xml>文章 RSS</a></li></ul></section></div></div></div><div class=container-footer><footer id=footer><div>&copy; 2025 <a href=https://DBL2017.github.io/>生如夏花 By
生如夏花</a>
| <a rel=nofollow target=_blank href=http://beian.miit.gov.cn/>广电总局</a></div><br><div><div class=github-badge><a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered
by</span><span class="badge-value bg-blue">Hugo</span></a></div><div class=github-badge><a href=https://DBL2017.github.io/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">生如夏花</span></a></div><div class=github-badge><a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a></div></div></footer><script src=/js/jquery.fancybox.min.min.7fa821ee946e58947030e5d007d358378119205e16b74ab4d0c60560a36d0414a775f9dbe0586ce12723c75cea8794fabadd1f33100a9ee22f6da3826256c0ef.js integrity="sha512-f6gh7pRuWJRwMOXQB9NYN4EZIF4Wt0q00MYFYKNtBBSndfnb4Fhs4Scjx1zqh5T6ut0fMxAKnuIvbaOCYlbA7w==" crossorigin=anonymous></script><a id=rocket href=#top></a><script src=/js/totop.min.8c7573186baa30f09c49b5cf3176c3b105785324d961b3d5c2f7f099d14673160a29aeebdec25909d046aa14936cd43451e17664662d518550d5e8998dbec670.js integrity="sha512-jHVzGGuqMPCcSbXPMXbDsQV4UyTZYbPVwvfwmdFGcxYKKa7r3sJZCdBGqhSTbNQ0UeF2ZGYtUYVQ1eiZjb7GcA==" crossorigin=anonymous></script><script src=/js/clipboard.min.0765794be1674926c1a3810afcf039f605f367cb11cef727ad49e6aa70f9fca0a37d329d64c55822896869eb0960763e73e085ee7675cbc497e4d3256a6e6a67.js integrity="sha512-B2V5S+FnSSbBo4EK/PA59gXzZ8sRzvcnrUnmqnD5/KCjfTKdZMVYIoloaesJYHY+c+CF7nZ1y8SX5NMlam5qZw==" crossorigin=anonymous></script><script>var spy=new Gumshoe("#TableOfContents a",{nested:!0,nestedClass:"active"})</script><script>hljs.highlightAll()</script></div></div></body></html>