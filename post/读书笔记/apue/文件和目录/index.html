<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>文件和目录 | 生如夏花</title><meta property="og:title" content="文件和目录 - 生如夏花"><meta property="og:type" content="article"><meta property="article:published_time" content='2022-03-04T23:16:53+08:00'><meta property="article:modified_time" content='2022-03-04T23:16:53+08:00'><meta name=Keywords content="C语言,Linux系统开发,物联网,博客,项目管理,软件架构"><meta name=description content="描述文件属性的基本结构`struct stat`，文件权限判断，设置用户ID位，设置组ID位以及粘着位等，其次进程的实际用户ID、有效用户ID、有效组ID、附属组ID以及进程访问文件权限检测，其次是文件的相关操作函数，比如access()，chmod()，umask()，chown()等，之后是软链接、硬链接，最后是创建删除以及读写目录及其相关接口mkdir、chdir等。"><meta name=author content><meta property="og:url" content="https://DBL2017.github.io/post/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/apue/%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95/"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css><link rel=stylesheet href=/css/badge.min.c6e6f065a59e7bd54d7bd6bf2f3998a1fcb485582aca59bb6257806f0d956d2f5785e1b9cadfe4452359086749d379aabe5bc50132b1bfcc994e5f9d7150ccbe.css integrity="sha512-xubwZaWee9VNe9a/LzmYofy0hVgqylm7YleAbw2VbS9XheG5yt/kRSNZCGdJ03mqvlvFATKxv8yZTl+dcVDMvg==" crossorigin=anonymous><link rel=stylesheet href=/css/header.min.9e74ad2f7e23fb54e2da3ef2f1eb6498897cd4139d181133b5e641f107980364ccfbcea731badb693b4a50819c388b6f8cab037346daf142114f86f14faa8766.css integrity="sha512-nnStL34j+1Ti2j7y8etkmIl81BOdGBEzteZB8QeYA2TM+86nMbrbaTtKUIGcOItvjKsDc0ba8UIRT4bxT6qHZg==" crossorigin=anonymous><link rel=stylesheet href=/css/table.min.032852d8d049c55be5cd0a27bf8c7b09c8ea549fb719c2fd0231ebd262fdddb5aaaf391dabeb89ce33bcbe49f13ee8a530822a26f76b675af23473ed07b95d2e.css integrity="sha512-AyhS2NBJxVvlzQonv4x7CcjqVJ+3GcL9AjHr0mL93bWqrzkdq+uJzjO8vknxPuilMIIqJvdrZ1ryNHPtB7ldLg==" crossorigin=anonymous><link rel=stylesheet href=/css/baseof.min.7799d75bdec4c3ec6c9b5cc5291d9f452a0103bfe0f58e5d705baa7abe57f2e977a22fc3ff0b101c063d7f39931420391a0dc2b5ddc7b306110ef51ab01cb247.css integrity="sha512-d5nXW97Ew+xsm1zFKR2fRSoBA7/g9Y5dcFuqer5X8ul3oi/D/wsQHAY9fzmTFCA5Gg3Ctd3HswYRDvUasByyRw==" crossorigin=anonymous><link rel=stylesheet href=/css/rocket.min.96a6be31cd3df9dcd4e7e131e9fcb0e63149da1da6a23df5ed8c8e0ccf0436f4c95aad5ded6a69e7fba5c051f8cc00466fcedaa07e4c7f59492d4a15aba2e936.css integrity="sha512-lqa+Mc09+dzU5+Ex6fyw5jFJ2h2moj317YyODM8ENvTJWq1d7Wpp5/ulwFH4zABGb87aoH5Mf1lJLUoVq6LpNg==" crossorigin=anonymous><link rel=stylesheet href=/css/toc.min.37fe0fbda85f18e890be33d1e0a82b29b78f1266bfe17e63679d86b84af41b0124616f83d28227783c214e26bd8d70223d405128cc355d865d7016623a163068.css integrity="sha512-N/4PvahfGOiQvjPR4KgrKbePEma/4X5jZ52GuEr0GwEkYW+D0oIneDwhTia9jXAiPUBRKMw1XYZdcBZiOhYwaA==" crossorigin=anonymous><link rel=stylesheet href=/css/clipboard.min.5e6a0198e50c850ced7dc2ba6f282ecaab21a8daad9eee626b990120818361b4b0007128d73957d5682346c88a6f9831f5872051e5f12da830cc29ca75676403.css integrity="sha512-XmoBmOUMhQztfcK6byguyqshqNqtnu5ia5kBIIGDYbSwAHEo1zlX1WgjRsiKb5gx9YcgUeXxLagwzCnKdWdkAw==" crossorigin=anonymous><link rel=stylesheet href=/css/style.min.c3c6800c298f5369e9063d72a2b534abf64bf1ee7bec54c70f15a3219ad0ae104e388252951ef21ce76c1d3b7ec5eb40939179a89684e52034d885e6e002e1ea.css integrity="sha512-w8aADCmPU2npBj1yorU0q/ZL8e577FTHDxWjIZrQrhBOOIJSlR7yHOdsHTt+xetAk5F5qJaE5SA02IXm4ALh6g==" crossorigin=anonymous><link rel="shortcut icon" href=/img/favicon.png type=image/x-icon><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/vim.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/latex.min.js></script><script src=/js/gumshoe.min.min.9dec1df0371d73b03324ed4bb78a6d5b2e84af6a37b11ce799808a26d70dfd156595f8d23c42db9e4866f12b4c0de664cfd032fa6f95bdaaada1bacdb235e79e.js integrity="sha512-newd8Dcdc7AzJO1Lt4ptWy6Er2o3sRznmYCKJtcN/RVllfjSPELbnkhm8StMDeZkz9Ay+m+VvaqtobrNsjXnng==" crossorigin=anonymous></script></head><body><div class=container><div class=container-header><header><div class=header-main><div class=header-site-name><a id=header-title href=https://DBL2017.github.io/>生如夏花</a><p class=description>专注于工业物联网行业数据采集，嵌入式Linux系统裁剪，5G智慧网关软件开发等</p></div><div class=header-menu><nav id=header-nav-menu><a href=https://DBL2017.github.io/>首页</a>
<a href=https://DBL2017.github.io/series/ title=系列>系列</a>
<a href=https://DBL2017.github.io/categories/ title=分类>分类</a>
<a href=https://DBL2017.github.io/tags/ title=标签>标签</a>
<a href=https://DBL2017.github.io/archives/ title=归档>归档</a>
<a href=https://DBL2017.github.io/about/ title=关于>关于</a></nav></div></div></header></div><div class=container-content><div class=content-center><div class=main-single><div class=single-toc><div class=post-toc><h2 class=post-toc-title><a href=#>目录</a></h2><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#文件属性和类型>文件属性和类型</a><ul><li><a href=#文件类型>文件类型</a></li></ul></li><li><a href=#文件进程用户权限>文件进程用户权限</a><ul><li><a href=#与进程有关的id>与进程有关的ID</a></li><li><a href=#与文件有关的id>与文件有关的ID</a><ul><li><a href=#示例一判断设置用户id位>示例一：判断设置用户ID位</a></li><li><a href=#示例二进程有效用户id变化>示例二：进程有效用户ID变化</a></li></ul></li><li><a href=#文件的所有权限>文件的所有权限</a></li><li><a href=#进程访问文件之权限判断规则>进程访问文件之权限判断规则</a></li><li><a href=#权限测试函数access和faccessat>权限测试函数access()和faccessat()</a></li><li><a href=#权限设置函数umask>权限设置函数umask()</a></li><li><a href=#权限修改函数chmodfchmod和fchmodat>权限修改函数chmod()、fchmod()和fchmodat()</a></li><li><a href=#粘着位>粘着位</a></li><li><a href=#文件用户更改函数chownfchownfchownat和lchown>文件用户更改函数chown()、fchown()、fchownat()和lchown()</a></li></ul></li><li><a href=#文件操作>文件操作</a><ul><li><a href=#文件长度和空洞>文件长度和空洞</a></li><li><a href=#文件截断truncate>文件截断truncate()</a></li><li><a href=#重命名>重命名</a></li></ul></li><li><a href=#文件系统简介>文件系统简介</a><ul><li><a href=#inode>inode</a></li><li><a href=#目录项>目录项</a></li></ul></li><li><a href=#硬链接和符号链接>硬链接和符号链接</a><ul><li><a href=#硬链接>硬链接</a></li><li><a href=#符号链接>符号链接</a></li></ul></li><li><a href=#文件时间>文件时间</a></li><li><a href=#目录>目录</a><ul><li><a href=#创建和删除目录>创建和删除目录</a></li><li><a href=#读目录>读目录</a></li><li><a href=#进程的工作目录>进程的工作目录</a></li></ul></li><li><a href=#设备特殊文件>设备特殊文件</a></li></ul></nav></div></div></div><div class=single-article><article class=post><header><h1 class=post-title>文件和目录</h1></header><date class="post-meta meta-date"><span class=meta-category><a href=/archives/#2022>2022年3月4日</a></span></date><div class=post-meta><span>|</span>
<span class=meta-category><a href=/categories/#%e8%af%bb%e4%b9%a6%e7%ac%94%e8%ae%b0>读书笔记</a></span></div><div class=post-meta><span>|</span>
<span class=meta-category><a href=/series/#APUE>APUE</a></span></div><div class=post-meta><span>|</span>
<span>共13039字</span></div><div class=post-meta><span>|</span>
<span>阅读时长(27分钟)</span></div><div class=clear style=display:none><div class=toc-article><div class=toc-title>文章目录</div></div></div><div class=post-content><p>本文描述了文件的属性，主要是<code>struct stat</code>结构体中的相关字段，比如文件所有者ID、文件所属组ID、块大小等。</p><p>其次详细描述了文件权限的相关内容，包括文件的基本权限、进程创建、读写文件的权限验证规则以及修改文件权限的相关接口等。</p><p>最后是文件系统简介，包含<code>inode</code>、目录项等，以及文件时间，创建删除以及读写目录等。</p><h2 id=文件属性和类型><a href=#%e6%96%87%e4%bb%b6%e5%b1%9e%e6%80%a7%e5%92%8c%e7%b1%bb%e5%9e%8b>文件属性和类型</a></h2><p><code>struct stat</code>结构体是系统对文件属性的一个抽象，具体内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>stat</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>dev_t</span>     <span class=n>st_dev</span><span class=p>;</span>         <span class=cm>/* ID of device containing file */</span>
</span></span><span class=line><span class=cl>    <span class=kt>ino_t</span>     <span class=n>st_ino</span><span class=p>;</span>         <span class=cm>/* Inode number */</span>
</span></span><span class=line><span class=cl>    <span class=kt>mode_t</span>    <span class=n>st_mode</span><span class=p>;</span>        <span class=cm>/* File type and mode */</span>
</span></span><span class=line><span class=cl>    <span class=kt>nlink_t</span>   <span class=n>st_nlink</span><span class=p>;</span>       <span class=cm>/* Number of hard links */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uid_t</span>     <span class=n>st_uid</span><span class=p>;</span>         <span class=cm>/* User ID of owner */</span>
</span></span><span class=line><span class=cl>    <span class=kt>gid_t</span>     <span class=n>st_gid</span><span class=p>;</span>         <span class=cm>/* Group ID of owner */</span>
</span></span><span class=line><span class=cl>    <span class=kt>dev_t</span>     <span class=n>st_rdev</span><span class=p>;</span>        <span class=cm>/* Device ID (if special file) */</span>
</span></span><span class=line><span class=cl>    <span class=kt>off_t</span>     <span class=n>st_size</span><span class=p>;</span>        <span class=cm>/* Total size, in bytes */</span>
</span></span><span class=line><span class=cl>    <span class=kt>blksize_t</span> <span class=n>st_blksize</span><span class=p>;</span>     <span class=cm>/* Block size for filesystem I/O */</span>
</span></span><span class=line><span class=cl>    <span class=kt>blkcnt_t</span>  <span class=n>st_blocks</span><span class=p>;</span>      <span class=cm>/* Number of 512B blocks allocated */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Since Linux 2.6, the kernel supports nanosecond
</span></span></span><span class=line><span class=cl><span class=cm>        precision for the following timestamp fields.
</span></span></span><span class=line><span class=cl><span class=cm>        For the details before Linux 2.6, see NOTES. */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>timespec</span> <span class=n>st_atim</span><span class=p>;</span>  <span class=cm>/* Time of last access */</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>timespec</span> <span class=n>st_mtim</span><span class=p>;</span>  <span class=cm>/* Time of last modification */</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>timespec</span> <span class=n>st_ctim</span><span class=p>;</span>  <span class=cm>/* Time of last status change */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define st_atime st_atim.tv_sec      </span><span class=cm>/* Backward compatibility */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#define st_mtime st_mtim.tv_sec
</span></span></span><span class=line><span class=cl><span class=cp>#define st_ctime st_ctim.tv_sec
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=p>};</span>
</span></span></code></pre></div><p>Ubuntu20.04中根据头文件<code>/usr/include/x86_64-linux-gnu/bits/stat.h</code>文件中的提示，需要定义<code>__USE_GNU</code>才可以使用<code>st_atim， st_mtim, st_ctim</code>参数。否则只能使用<code>st_atime， st_mtime, st_ctime</code>参数。</p><p><strong>程序获取<code>struct stat</code>结构体的方式</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>stat</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=kr>restrict</span> <span class=n>pathname</span><span class=p>,</span> <span class=k>struct</span> <span class=n>stat</span> <span class=o>*</span><span class=kr>restrict</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>fstat</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=k>struct</span> <span class=n>stat</span> <span class=o>*</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>lstat</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=kr>restrict</span> <span class=n>pathname</span><span class=p>,</span> <span class=k>struct</span> <span class=n>stat</span> <span class=o>*</span><span class=kr>restrict</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>fstatat</span><span class=p>(</span><span class=kt>int</span> <span class=n>dirfd</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=kr>restrict</span> <span class=n>pathname</span><span class=p>,</span> <span class=k>struct</span> <span class=n>stat</span> <span class=o>*</span><span class=kr>restrict</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>//成功返回0，失败返回-1
</span></span></span></code></pre></div><hr><p><code>stat</code>函数返回<code>pathname</code>参数指向的文件的属性结构体<code>struct stat</code>。</p><p><code>fstat</code>函数返回在描述符<code>fd</code>上打开的文件的有关信息。</p><p><code>lstat</code>函数仅会对链接文件进行特殊处理，指向链接文件本身。其他的和<code>stat</code>函数一致。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>print_stat</span><span class=p>(</span><span class=k>struct</span> <span class=n>stat</span><span class=o>*</span> <span class=n>pFileStat</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_mode: %X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_mode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_inf: %lu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_ino</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_dev: %lu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_dev</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_rdev: %lu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_rdev</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_nlink: %lu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_nlink</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_uid: %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_uid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_gid: %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_gid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_size: %ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_atime: %lu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_atime</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_mtime: %ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_mtime</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_ctime: %lu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_ctime</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_blksize: %ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_blksize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_blocks: %ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_blocks</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>stat</span> <span class=n>fileStat</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>stat</span><span class=p>(</span><span class=s>&#34;./test&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>fileStat</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;stat failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>print_stat</span><span class=p>(</span><span class=o>&amp;</span><span class=n>fileStat</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>stat</span> <span class=n>fileStat1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;./test&#34;</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>))</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;open failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>fstat</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>fileStat1</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;fstat failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;fileStat1:</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>print_stat</span><span class=p>(</span><span class=o>&amp;</span><span class=n>fileStat1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>stat</span> <span class=n>fileStat2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fd1</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>fd1</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;./test-link&#34;</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>))</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;open failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>fstat</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>fileStat2</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;fstat failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;fileStat2:</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>print_stat</span><span class=p>(</span><span class=o>&amp;</span><span class=n>fileStat2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>close</span><span class=p>(</span><span class=n>fd1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=err>$</span> <span class=p>.</span><span class=o>/</span><span class=n>stat_test</span> 
</span></span><span class=line><span class=cl><span class=nl>st_mode</span><span class=p>:</span> <span class=mi>81</span><span class=n>B4</span>
</span></span><span class=line><span class=cl><span class=nl>st_inf</span><span class=p>:</span> <span class=mi>1976724</span>
</span></span><span class=line><span class=cl><span class=nl>st_dev</span><span class=p>:</span> <span class=mi>2053</span>
</span></span><span class=line><span class=cl><span class=nl>st_rdev</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nl>st_nlink</span><span class=p>:</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=nl>st_uid</span><span class=p>:</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl><span class=nl>st_gid</span><span class=p>:</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl><span class=nl>st_size</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nl>st_atime</span><span class=p>:</span> <span class=mi>1646486168</span>
</span></span><span class=line><span class=cl><span class=nl>st_mtime</span><span class=p>:</span> <span class=mi>1646486168</span>
</span></span><span class=line><span class=cl><span class=nl>st_ctime</span><span class=p>:</span> <span class=mi>1646488925</span>
</span></span><span class=line><span class=cl><span class=nl>st_blksize</span><span class=p>:</span> <span class=mi>4096</span>
</span></span><span class=line><span class=cl><span class=nl>st_blocks</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nl>fileStat1</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=nl>st_mode</span><span class=p>:</span> <span class=mi>81</span><span class=n>B4</span>
</span></span><span class=line><span class=cl><span class=nl>st_inf</span><span class=p>:</span> <span class=mi>1976724</span>
</span></span><span class=line><span class=cl><span class=nl>st_dev</span><span class=p>:</span> <span class=mi>2053</span>
</span></span><span class=line><span class=cl><span class=nl>st_rdev</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nl>st_nlink</span><span class=p>:</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=nl>st_uid</span><span class=p>:</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl><span class=nl>st_gid</span><span class=p>:</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl><span class=nl>st_size</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nl>st_atime</span><span class=p>:</span> <span class=mi>1646486168</span>
</span></span><span class=line><span class=cl><span class=nl>st_mtime</span><span class=p>:</span> <span class=mi>1646486168</span>
</span></span><span class=line><span class=cl><span class=nl>st_ctime</span><span class=p>:</span> <span class=mi>1646488925</span>
</span></span><span class=line><span class=cl><span class=nl>st_blksize</span><span class=p>:</span> <span class=mi>4096</span>
</span></span><span class=line><span class=cl><span class=nl>st_blocks</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nl>fileStat2</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=nl>st_mode</span><span class=p>:</span> <span class=mi>81</span><span class=n>B4</span>
</span></span><span class=line><span class=cl><span class=nl>st_inf</span><span class=p>:</span> <span class=mi>1976724</span>
</span></span><span class=line><span class=cl><span class=nl>st_dev</span><span class=p>:</span> <span class=mi>2053</span>
</span></span><span class=line><span class=cl><span class=nl>st_rdev</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nl>st_nlink</span><span class=p>:</span> <span class=mi>2</span> <span class=c1>// 硬链接数量为2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nl>st_uid</span><span class=p>:</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl><span class=nl>st_gid</span><span class=p>:</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl><span class=nl>st_size</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nl>st_atime</span><span class=p>:</span> <span class=mi>1646486168</span>
</span></span><span class=line><span class=cl><span class=nl>st_mtime</span><span class=p>:</span> <span class=mi>1646486168</span>
</span></span><span class=line><span class=cl><span class=nl>st_ctime</span><span class=p>:</span> <span class=mi>1646488925</span> <span class=c1>// 文件状态时间和文件修改时间不同
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nl>st_blksize</span><span class=p>:</span> <span class=mi>4096</span>
</span></span><span class=line><span class=cl><span class=nl>st_blocks</span><span class=p>:</span> <span class=mi>0</span>
</span></span></code></pre></div><hr><p><code>fstatat</code>函数为一个相对于打开目录(<code>dirfd</code>指向的)的路径名返回文件统计信息。</p><p><code>flag</code>参数控制是否跟随符号链接还是指向符号链接本身，当值为<code>AT_SYMLINK_NOFLLOW</code>时指向符号链接本身。默认情况下返回的是符号链接指向的文件。</p><p>如果<code>dirfd</code>参数是<code>AT_FDCWD</code>，并且<code>pathname</code>参数是一个相对路径名，<code>fstatat</code>会计算相对于当前目录的<code>pathname</code>参数。如果<code>pathname</code>是绝对路径，则<code>fd</code>参数被忽略。根据<code>flag</code>的取值不同，<code>fstatat</code>的作用和<code>stat</code>和<code>lstat</code>类似。</p><p>下面是<code>fstatat</code>函数的使用范例</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#define _XOPEN_SOURCE 700 </span><span class=cm>/* Or define _POSIX_C_SOURCE &gt;= 200809 */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>static</span> <span class=kt>void</span> <span class=nf>print_stat</span><span class=p>(</span><span class=k>struct</span> <span class=n>stat</span><span class=o>*</span> <span class=n>pFileStat</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_mode: %X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_mode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_inf: %lu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_ino</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_dev: %lu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_dev</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_rdev: %lu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_rdev</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_nlink: %lu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_nlink</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_uid: %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_uid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_gid: %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_gid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_size: %ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_atime: %lu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_atime</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_mtime: %ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_mtime</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_ctime: %lu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_ctime</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_blksize: %ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_blksize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;st_blocks: %ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pFileStat</span><span class=o>-&gt;</span><span class=n>st_blocks</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>dirfd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;.&#34;</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>dirfd</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;open failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//以dirfd为基础相对目录访问文件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;relative:</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>stat</span> <span class=n>fileStat</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>fstatat</span><span class=p>(</span><span class=n>dirfd</span><span class=p>,</span> <span class=s>&#34;./test&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>fileStat</span><span class=p>,</span> <span class=n>AT_SYMLINK_NOFOLLOW</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;fstatat failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>print_stat</span><span class=p>(</span><span class=o>&amp;</span><span class=n>fileStat</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>close</span><span class=p>(</span><span class=n>dirfd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//以当前目录为基础的相对目录访问文件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;relative1:</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>stat</span> <span class=n>fileStat1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>fstatat</span><span class=p>(</span><span class=n>AT_FDCWD</span><span class=p>,</span> <span class=s>&#34;test&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>fileStat1</span><span class=p>,</span> <span class=n>AT_SYMLINK_NOFOLLOW</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;fstatat failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>print_stat</span><span class=p>(</span><span class=o>&amp;</span><span class=n>fileStat1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//以绝对目录访问文件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;absolute:</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>stat</span> <span class=n>fileStat2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>fstatat</span><span class=p>(</span><span class=n>AT_FDCWD</span><span class=p>,</span> <span class=s>&#34;/home/blduan/Documents/code_snippet/4_chapter/test&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=n>fileStat2</span><span class=p>,</span> <span class=n>AT_SYMLINK_NOFOLLOW</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;fstatat failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>print_stat</span><span class=p>(</span><span class=o>&amp;</span><span class=n>fileStat2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>//执行结果如下：通过3种方式都可以访问到指定文件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>$</span> <span class=p>.</span><span class=o>/</span><span class=n>fstatat_test</span> 
</span></span><span class=line><span class=cl><span class=nl>relative</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=nl>st_mode</span><span class=p>:</span> <span class=mi>81</span><span class=n>B4</span>
</span></span><span class=line><span class=cl><span class=nl>st_inf</span><span class=p>:</span> <span class=mi>1976724</span>
</span></span><span class=line><span class=cl><span class=nl>st_dev</span><span class=p>:</span> <span class=mi>2053</span>
</span></span><span class=line><span class=cl><span class=nl>st_rdev</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nl>st_nlink</span><span class=p>:</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=nl>st_uid</span><span class=p>:</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl><span class=nl>st_gid</span><span class=p>:</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl><span class=nl>st_size</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nl>st_atime</span><span class=p>:</span> <span class=mi>1646486168</span>
</span></span><span class=line><span class=cl><span class=nl>st_mtime</span><span class=p>:</span> <span class=mi>1646486168</span>
</span></span><span class=line><span class=cl><span class=nl>st_ctime</span><span class=p>:</span> <span class=mi>1646488925</span>
</span></span><span class=line><span class=cl><span class=nl>st_blksize</span><span class=p>:</span> <span class=mi>4096</span>
</span></span><span class=line><span class=cl><span class=nl>st_blocks</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nl>relative1</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=nl>st_mode</span><span class=p>:</span> <span class=mi>81</span><span class=n>B4</span>
</span></span><span class=line><span class=cl><span class=nl>st_inf</span><span class=p>:</span> <span class=mi>1976724</span>
</span></span><span class=line><span class=cl><span class=nl>st_dev</span><span class=p>:</span> <span class=mi>2053</span>
</span></span><span class=line><span class=cl><span class=nl>st_rdev</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nl>st_nlink</span><span class=p>:</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=nl>st_uid</span><span class=p>:</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl><span class=nl>st_gid</span><span class=p>:</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl><span class=nl>st_size</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nl>st_atime</span><span class=p>:</span> <span class=mi>1646486168</span>
</span></span><span class=line><span class=cl><span class=nl>st_mtime</span><span class=p>:</span> <span class=mi>1646486168</span>
</span></span><span class=line><span class=cl><span class=nl>st_ctime</span><span class=p>:</span> <span class=mi>1646488925</span>
</span></span><span class=line><span class=cl><span class=nl>st_blksize</span><span class=p>:</span> <span class=mi>4096</span>
</span></span><span class=line><span class=cl><span class=nl>st_blocks</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nl>absolute</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=nl>st_mode</span><span class=p>:</span> <span class=mi>81</span><span class=n>B4</span>
</span></span><span class=line><span class=cl><span class=nl>st_inf</span><span class=p>:</span> <span class=mi>1976724</span>
</span></span><span class=line><span class=cl><span class=nl>st_dev</span><span class=p>:</span> <span class=mi>2053</span>
</span></span><span class=line><span class=cl><span class=nl>st_rdev</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nl>st_nlink</span><span class=p>:</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=nl>st_uid</span><span class=p>:</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl><span class=nl>st_gid</span><span class=p>:</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl><span class=nl>st_size</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nl>st_atime</span><span class=p>:</span> <span class=mi>1646486168</span>
</span></span><span class=line><span class=cl><span class=nl>st_mtime</span><span class=p>:</span> <span class=mi>1646486168</span>
</span></span><span class=line><span class=cl><span class=nl>st_ctime</span><span class=p>:</span> <span class=mi>1646488925</span>
</span></span><span class=line><span class=cl><span class=nl>st_blksize</span><span class=p>:</span> <span class=mi>4096</span>
</span></span><span class=line><span class=cl><span class=nl>st_blocks</span><span class=p>:</span> <span class=mi>0</span>
</span></span></code></pre></div><h3 id=文件类型><a href=#%e6%96%87%e4%bb%b6%e7%b1%bb%e5%9e%8b>文件类型</a></h3><table><thead><tr><th style=text-align:left>文件类型</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>普通文件regular file</td><td style=text-align:left>最常用的文件类型，但是二进制可执行文件必须遵循一种标准化的格式</td></tr><tr><td style=text-align:left>目录文件directory file</td><td style=text-align:left>这种文件中包含了其他文件的名字以及指向与这些文件有关信息的指针</td></tr><tr><td style=text-align:left>块特殊文件block special file</td><td style=text-align:left>这种文件提供对设备带缓冲的访问，每次访问必须以固定长度为单位</td></tr><tr><td style=text-align:left>字符特殊文件character special file</td><td style=text-align:left>这种类型文件提供对设备不带缓冲的访问，每次访问长度可变。系统中的设备分为以上两类</td></tr><tr><td style=text-align:left>FIFO</td><td style=text-align:left>这种类型的文件用于进程间通信，也别成为命名管道</td></tr><tr><td style=text-align:left>套接字socket</td><td style=text-align:left>用于网络通信，也可用于进程间的非网络通信</td></tr><tr><td style=text-align:left>符号链接symbolic link</td><td style=text-align:left>这种类型的文件指向另一个文件</td></tr></tbody></table><p>文件类型信息存储在文件属性结构体<code>struct stat</code>的成员<code>st_mode</code>中，可以用以下宏确定文件类型：</p><table><thead><tr><th style=text-align:left>宏</th><th style=text-align:left>文件类型</th></tr></thead><tbody><tr><td style=text-align:left>S_ISREG()</td><td style=text-align:left>普通文件</td></tr><tr><td style=text-align:left>S_ISDIR()</td><td style=text-align:left>目录文件</td></tr><tr><td style=text-align:left>S_ISCHR()</td><td style=text-align:left>字符特殊文件</td></tr><tr><td style=text-align:left>S_ISBLK()</td><td style=text-align:left>块特殊文件</td></tr><tr><td style=text-align:left>S_ISFIFO()</td><td style=text-align:left>管道或FIFO</td></tr><tr><td style=text-align:left>S_ISLNK()</td><td style=text-align:left>链接文件</td></tr><tr><td style=text-align:left>S_ISSOCK()</td><td style=text-align:left>套接字</td></tr></tbody></table><p>确定进程间通信的类型</p><table><thead><tr><th style=text-align:left>宏</th><th style=text-align:left>文件类型</th></tr></thead><tbody><tr><td style=text-align:left>S_TYPEISMQ()</td><td style=text-align:left>消息队列</td></tr><tr><td style=text-align:left>S_TYPEISSEM()</td><td style=text-align:left>信号量</td></tr><tr><td style=text-align:left>S_TYPEISSHM()</td><td style=text-align:left>共享内存</td></tr></tbody></table><p>下面选中一些文件查看其类型</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>stat</span> <span class=n>fileStat</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>argc</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s: &#34;</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nf>lstat</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>fileStat</span><span class=p>)</span><span class=o>&lt;</span><span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;lstat failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nf>S_ISREG</span><span class=p>(</span><span class=n>fileStat</span><span class=p>.</span><span class=n>st_mode</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;regular file</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=nf>S_ISDIR</span><span class=p>(</span><span class=n>fileStat</span><span class=p>.</span><span class=n>st_mode</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;directory file</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=nf>S_ISCHR</span><span class=p>(</span><span class=n>fileStat</span><span class=p>.</span><span class=n>st_mode</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;character special file</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=nf>S_ISBLK</span><span class=p>(</span><span class=n>fileStat</span><span class=p>.</span><span class=n>st_mode</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;block special file</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=nf>S_ISFIFO</span><span class=p>(</span><span class=n>fileStat</span><span class=p>.</span><span class=n>st_mode</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;FIFO</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=nf>S_ISLNK</span><span class=p>(</span><span class=n>fileStat</span><span class=p>.</span><span class=n>st_mode</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;symbolic link</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=nf>S_ISSOCK</span><span class=p>(</span><span class=n>fileStat</span><span class=p>.</span><span class=n>st_mode</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;socket</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;unknow mode</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=err>$</span> <span class=p>.</span><span class=o>/</span><span class=n>lstat_file_type_test</span> <span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>passwd</span> <span class=o>/</span><span class=n>etc</span><span class=o>/</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>log</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>tty</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>sr0</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>cdrom</span> 
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=nl>passwd</span><span class=p>:</span> <span class=n>regular</span> <span class=n>file</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>etc</span><span class=o>/:</span> <span class=n>directory</span> <span class=n>file</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=nl>log</span><span class=p>:</span> <span class=n>symbolic</span> <span class=n>link</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=nl>tty</span><span class=p>:</span> <span class=n>character</span> <span class=n>special</span> <span class=n>file</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=nl>sr0</span><span class=p>:</span> <span class=n>block</span> <span class=n>special</span> <span class=n>file</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=nl>cdrom</span><span class=p>:</span> <span class=n>symbolic</span> <span class=n>link</span>
</span></span></code></pre></div><h2 id=文件进程用户权限><a href=#%e6%96%87%e4%bb%b6%e8%bf%9b%e7%a8%8b%e7%94%a8%e6%88%b7%e6%9d%83%e9%99%90>文件进程用户权限</a></h2><h3 id=与进程有关的id><a href=#%e4%b8%8e%e8%bf%9b%e7%a8%8b%e6%9c%89%e5%85%b3%e7%9a%84id>与进程有关的ID</a></h3><table><thead><tr><th style=text-align:left>ID</th><th style=text-align:left>来源及用途</th></tr></thead><tbody><tr><td style=text-align:left>实际用户ID</td><td style=text-align:left>登录时的用户，取自口令文件中的登录项</td></tr><tr><td style=text-align:left>实际组ID</td><td style=text-align:left>登录用户所在的组</td></tr><tr><td style=text-align:left>有效用户ID</td><td style=text-align:left>通常情况下和实际用户ID相同，但可以通过设置条件改变。<strong>有效用户ID和有效组ID决定文件访问权限</strong>。</td></tr><tr><td style=text-align:left>有效组ID</td><td style=text-align:left>同有效用户ID</td></tr><tr><td style=text-align:left>附属组ID</td><td style=text-align:left>通常情况下为登录用户的所在的附属组。<strong>附属组ID也决定文件访问权限</strong>。</td></tr><tr><td style=text-align:left>保存的设置用户ID</td><td style=text-align:left>有效用户发生变化时产生，用于设置回原来的有效用户ID</td></tr><tr><td style=text-align:left>保存的设置组ID</td><td style=text-align:left>同上</td></tr></tbody></table><h3 id=与文件有关的id><a href=#%e4%b8%8e%e6%96%87%e4%bb%b6%e6%9c%89%e5%85%b3%e7%9a%84id>与文件有关的ID</a></h3><p>每个文件都有所有者<code>owner</code>和所属组<code>group</code>，可以通过<code>ls -l</code>命令来查看。</p><p>文件的所有者和所属组的ID和登录用户的ID和组ID不一定相同。例如即便普通用户登录时，<code>/etc/passwd</code>文件的所有者和组所有者都属于<code>root</code>，ID始终都为0。</p><p><strong>文件的所有者ID和组所有者ID保存在文件属性结构体<code>struct stat</code>中的<code>st_uid</code>和<code>st_gid</code>字段中</strong>。</p><p><strong>设置用户ID位和设置组ID位保存在文件的<code>st_mode</code>值中，可以使用宏<code>S_ISUID</code>和<code>S_ISGID</code>测试</strong>。</p><p>正常情况下，当执行一个程序文件时，进程的有效用户ID和有效组ID就是实际用户ID和实际组ID。</p><p>但是当对程序文件设置了一个标志（即<strong>设置用户ID位</strong>，其含义是当执行此文件时，进程的有效用户ID设置为文件所有者的用户ID）并且当程序文件的所有者为root时，进程的有效用户ID就为root了，也就有了超级用户权限。</p><p>例如<code>/usr/bin/passwd</code>文件的所有者和组所有者为root，当普通用户执行该文件时，<code>passwd</code>进程就有了root权限，可以将用户的新口令写入到文件<code>/etc/shadow</code>中。</p><p><strong>root权限的进程拥有文件的所有权限，但是想要执行文件的话，该文件必须要至少有一个可执行权限，表明它是可执行的。</strong></p><h4 id=示例一判断设置用户id位><a href=#%e7%a4%ba%e4%be%8b%e4%b8%80%e5%88%a4%e6%96%ad%e8%ae%be%e7%bd%ae%e7%94%a8%e6%88%b7id%e4%bd%8d>示例一：判断设置用户ID位</a></h4><p>下面的示例用于判断可执行文件是否设置了设置用户ID位和设置组ID位：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>stat</span> <span class=n>fileProps</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>argc</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// lstat函数对于链接返回其自身，而非链接指向的文件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nf>lstat</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>fileProps</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;lstat failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 设置了设置用户ID位，进程以文件所有者的用户ID作为有效用户ID
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>S_ISUID</span> <span class=o>&amp;</span> <span class=n>fileProps</span><span class=p>.</span><span class=n>st_mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s: set user id</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>S_ISGID</span> <span class=o>&amp;</span> <span class=n>fileProps</span><span class=p>.</span><span class=n>st_mode</span><span class=p>)</span><span class=c1>// 有效组ID同理
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s: set group id</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=err>$</span> <span class=n>ls</span> <span class=o>-</span><span class=n>l</span> <span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>passwd</span> <span class=p>.</span><span class=o>/</span><span class=n>test</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>rwSrwSr</span><span class=o>--</span> <span class=mi>1</span> <span class=n>blduan</span> <span class=n>blduan</span>     <span class=mi>0</span> <span class=n>Mar</span>  <span class=mi>6</span> <span class=mo>05</span><span class=o>:</span><span class=mi>38</span> <span class=p>.</span><span class=o>/</span><span class=n>test</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>rwsr</span><span class=o>-</span><span class=n>xr</span><span class=o>-</span><span class=n>x</span> <span class=mi>1</span> <span class=n>root</span>   <span class=n>root</span>   <span class=mi>68208</span> <span class=n>Jul</span> <span class=mi>14</span>  <span class=mi>2021</span> <span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>passwd</span>
</span></span><span class=line><span class=cl><span class=err>$</span><span class=p>.</span><span class=o>/</span><span class=n>lstat_file_user_test</span> <span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>passwd</span> <span class=p>.</span><span class=o>/</span><span class=n>test</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=nl>passwd</span><span class=p>:</span> <span class=n>set</span> <span class=n>user</span> <span class=n>id</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=o>/</span><span class=nl>test</span><span class=p>:</span> <span class=n>set</span> <span class=n>user</span> <span class=n>id</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=o>/</span><span class=nl>test</span><span class=p>:</span> <span class=n>set</span> <span class=n>group</span> <span class=n>id</span>
</span></span></code></pre></div><p>从结果中可以看到，<code>/usr/bin/passwd</code>设置了设置用户ID位，测试程序<code>test</code>既设置了设置用户ID位，也设置设置组ID位。</p><h4 id=示例二进程有效用户id变化><a href=#%e7%a4%ba%e4%be%8b%e4%ba%8c%e8%bf%9b%e7%a8%8b%e6%9c%89%e6%95%88%e7%94%a8%e6%88%b7id%e5%8f%98%e5%8c%96>示例二：进程有效用户ID变化</a></h4><p>下面的示例中主要展示设置了设置用户ID位或设置组ID位之后，进程的有效用户ID的变化：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 普通用户</span>
</span></span><span class=line><span class=cl>$ ls -l process_euid_test
</span></span><span class=line><span class=cl>-rwxrwxr-x <span class=m>1</span> blduan blduan <span class=m>16800</span> Mar  <span class=m>6</span> 06:12 process_euid_test
</span></span><span class=line><span class=cl>$ ./process_euid_test 
</span></span><span class=line><span class=cl><span class=nv>euid</span><span class=o>=</span><span class=m>1000</span>
</span></span><span class=line><span class=cl><span class=nv>egid</span><span class=o>=</span><span class=m>1000</span>
</span></span><span class=line><span class=cl><span class=c1># 修改所有者</span>
</span></span><span class=line><span class=cl>$ sudo chown root process_euid_test
</span></span><span class=line><span class=cl>$ ls -l process_euid_test
</span></span><span class=line><span class=cl>-rwxrwxr-x <span class=m>1</span> root blduan <span class=m>16800</span> Mar  <span class=m>6</span> 06:12 process_euid_test
</span></span><span class=line><span class=cl><span class=c1># 设置设置用户ID位</span>
</span></span><span class=line><span class=cl>$ sudo chmod u+s process_euid_test
</span></span><span class=line><span class=cl>$ ls -l process_euid_test
</span></span><span class=line><span class=cl>-rwsrwxr-x <span class=m>1</span> root blduan <span class=m>16800</span> Mar  <span class=m>6</span> 06:12 process_euid_test
</span></span><span class=line><span class=cl>$ ./process_euid_test 
</span></span><span class=line><span class=cl><span class=nv>euid</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=nv>egid</span><span class=o>=</span><span class=m>1000</span>
</span></span><span class=line><span class=cl><span class=c1># 修改组所有者和设置设置组ID位</span>
</span></span><span class=line><span class=cl>$ sudo chgrp root process_euid_test
</span></span><span class=line><span class=cl>$ sudo chmod g+s process_euid_test
</span></span><span class=line><span class=cl>$ ls -l process_euid_test
</span></span><span class=line><span class=cl>-rwsrwsr-x <span class=m>1</span> root root <span class=m>16800</span> Mar  <span class=m>6</span> 06:12 process_euid_test
</span></span><span class=line><span class=cl>$ ./process_euid_test 
</span></span><span class=line><span class=cl><span class=nv>euid</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=nv>egid</span><span class=o>=</span><span class=m>0</span>
</span></span></code></pre></div><p>进程源码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;euid=%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=nf>geteuid</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;egid=%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=nf>getegid</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>从结果中可以看出，当更改测试程序的所有者以及所属组为<code>root</code>并设置了设置用户ID位以及设置组ID位之后，进程的有效用户ID和有效组ID都变为<code>root</code>用户对应的ID。</p><h3 id=文件的所有权限><a href=#%e6%96%87%e4%bb%b6%e7%9a%84%e6%89%80%e6%9c%89%e6%9d%83%e9%99%90>文件的所有权限</a></h3><table><thead><tr><th style=text-align:left>访问权限位</th><th style=text-align:left>含义</th></tr></thead><tbody><tr><td style=text-align:left>S_IRUSR</td><td style=text-align:left>所有者读</td></tr><tr><td style=text-align:left>S_IWUSR</td><td style=text-align:left>所有者写</td></tr><tr><td style=text-align:left>S_IXUSR</td><td style=text-align:left>所有者执行</td></tr><tr><td style=text-align:left>S_IRGRP</td><td style=text-align:left>组读</td></tr><tr><td style=text-align:left>S_IWGRP</td><td style=text-align:left>组写</td></tr><tr><td style=text-align:left>S_IXGRP</td><td style=text-align:left>组执行</td></tr><tr><td style=text-align:left>S_IROTH</td><td style=text-align:left>其他读</td></tr><tr><td style=text-align:left>S_IWOTH</td><td style=text-align:left>其他写</td></tr><tr><td style=text-align:left>S_IXOTH</td><td style=text-align:left>其他执行</td></tr></tbody></table><p>和文件权限相关的部分规则如下：</p><ol><li><strong>用绝对路径打开任意类型的文件时，必须对该路径中包含的各级目录具有执行权限</strong>。执行权限也常被成为搜索位。例如要打开<code>/usr/include/stdio.h</code>，则必须对目录/、/usr、/usr/include都有执行权限。<strong>对目录的读权限和执行权限的意义是不同的。</strong> 读权限允许获取该目录中所有文件名的列表。</li><li>对文件的读权限决定能否打开文件进行读操作。与<code>open</code>函数的<code>O_RDONLY</code>和<code>O_RDWR</code>标志有关。</li><li>对文件的写权限决定能否打开文件进行写操作。与<code>open</code>函数的<code>O_WRONLY</code>和<code>ORDWR</code>标志有关。</li><li><code>open</code>对文件指定<code>O_TRUNC</code>标志，则必须对文件具有写权限。</li><li><strong>在目录中创建新文件，必须对目录有写和执行权限</strong>。</li><li>删除现有文件，必须对目录有写和执行权限。</li><li>使用<code>exec</code>族函数执行一个文件时，必须对该文件具有执行权限，并且该文件必须是普通文件。</li></ol><h3 id=进程访问文件之权限判断规则><a href=#%e8%bf%9b%e7%a8%8b%e8%ae%bf%e9%97%ae%e6%96%87%e4%bb%b6%e4%b9%8b%e6%9d%83%e9%99%90%e5%88%a4%e6%96%ad%e8%a7%84%e5%88%99>进程访问文件之权限判断规则</a></h3><p><strong>内核每次打开、创建或删除一个文件时，内核都会进行文件访问权限测试</strong>，测试涉及到文件的所有者（<code>st_uid</code>和<code>st_gid</code>）、进程的有效ID（有效用户ID和有效组ID）以及进程的附属组ID。内核测试的具体流程如下：</p><ol><li>若进程的有效用户ID是0（超级用户），则允许访问。</li><li>若进程的有效用户ID等于文件的所有者ID（进程拥有此文件），那么如果文件所有者适当的访问权限位（所有者的读写执行权限）被设置，则允许访问；否则拒绝访问。</li><li>若进程的有效组ID或进程的附属组ID之一等于文件的组ID，那么如果文件的组适当的访问权限位被设置，则允许访问；否则拒绝访问。</li><li>若文件其他用户适当的访问权限位被设置，则允许访问；否则拒绝访问。</li></ol><p>注意：<em>上面4补依次执行，如果进程拥有此文件（满足第2步），则按文件所有者访问权限进行检测，不再查看组访问权限（第3步）。同理，如果进程不拥有此文件，但<strong>进程的有效组或附属组与文件所属组相等，则按组的访问权限进行检测，而不查看其他用户的访问权限</strong></em>。</p><p>测试流程如下图：
<a data-fancybox=gallery href=../%e6%96%87%e4%bb%b6%e5%92%8c%e7%9b%ae%e5%bd%95/%e5%86%85%e6%a0%b8%e6%b5%8b%e8%af%95%e6%96%87%e4%bb%b6%e6%9d%83%e9%99%90.png><img class=mx-auto alt src=../%e6%96%87%e4%bb%b6%e5%92%8c%e7%9b%ae%e5%bd%95/%e5%86%85%e6%a0%b8%e6%b5%8b%e8%af%95%e6%96%87%e4%bb%b6%e6%9d%83%e9%99%90.png></a></p><h3 id=权限测试函数access和faccessat><a href=#%e6%9d%83%e9%99%90%e6%b5%8b%e8%af%95%e5%87%bd%e6%95%b0access%e5%92%8cfaccessat>权限测试函数access()和faccessat()</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>access</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>pathname</span><span class=err>，</span> <span class=kt>int</span> <span class=n>mode</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>faccessat</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>pathname</span><span class=p>,</span>  <span class=kt>int</span> <span class=n>mode</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flag</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 成功返回0， 失败返回-1
</span></span></span></code></pre></div><p><code>access</code>和<code>faccessat</code>函数默认是按照实际用户ID和实际组ID进行权限测试的，而不是以进程的有效用户ID和有效组ID。</p><p>当<code>pathname</code>为绝对路径和<code>fd</code>参数值为<code>AT_FDCWD</code>并且<code>pathname</code>参数为相对路径时，<code>access</code>和<code>faccessat</code>函数作用一致。</p><p><code>flag</code>参数可以改变<code>faccessat</code>函数的行为，如果<code>flag</code>设置为AT_EACCESS访问检查的就是进程的有效用户ID和有效组ID。</p><p>下面验证<code>access</code>和<code>faccessat</code>函数的作用：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># access_test进程文件的所有者是blduan，并且设置了设置用户ID和设置组ID位，因此有效用户ID和有效组ID是用户blduan的ID。</span>
</span></span><span class=line><span class=cl><span class=c1># 但是登录用户是test，所以进程的实际用户ID和实际组ID是用户test的ID。</span>
</span></span><span class=line><span class=cl>test@ubuntu:/home/blduan/Documents/code_snippet/4_chapter$ ls -l access_test
</span></span><span class=line><span class=cl>-rwsrwsr-x <span class=m>1</span> blduan blduan <span class=m>17056</span> Mar  <span class=m>7</span> 07:16 access_test
</span></span><span class=line><span class=cl><span class=c1># 用户blduan具有读写执行权限，用户test仅有读权限。</span>
</span></span><span class=line><span class=cl>test@ubuntu:/home/blduan/Documents/code_snippet/4_chapter$ ls -l access_test.file 
</span></span><span class=line><span class=cl>-rwxrw-r-- <span class=m>1</span> blduan blduan <span class=m>0</span> Mar  <span class=m>7</span> 06:28 access_test.file
</span></span><span class=line><span class=cl><span class=c1># 测试执行结果和预期一致。</span>
</span></span><span class=line><span class=cl>test@ubuntu:/home/blduan/Documents/code_snippet/4_chapter$ ./access_test 
</span></span><span class=line><span class=cl>uid: 1001<span class=p>;</span> gid: <span class=m>1001</span>
</span></span><span class=line><span class=cl>euid: 1000<span class=p>;</span> egid: <span class=m>1000</span>
</span></span><span class=line><span class=cl><span class=c1># 实际用户权限</span>
</span></span><span class=line><span class=cl>exist access ok
</span></span><span class=line><span class=cl><span class=nb>read</span> access ok
</span></span><span class=line><span class=cl>access W_OK failed: Permission denied
</span></span><span class=line><span class=cl>access X_OK failed: Permission denied
</span></span><span class=line><span class=cl><span class=c1># 有效用户权限</span>
</span></span><span class=line><span class=cl><span class=nb>read</span> faccessat ok
</span></span><span class=line><span class=cl>write faccessat ok
</span></span><span class=line><span class=cl>execute faccessat ok
</span></span></code></pre></div><p>测试代码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;uid: %d; gid: %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=nf>getuid</span><span class=p>(),</span> <span class=nf>getgid</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;euid: %d; egid: %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=nf>geteuid</span><span class=p>(),</span> <span class=nf>getegid</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//实际用户验证权限
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>access</span><span class=p>(</span><span class=s>&#34;./access_test.file&#34;</span><span class=p>,</span> <span class=n>F_OK</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;access F_OK failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;exist access ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>access</span><span class=p>(</span><span class=s>&#34;./access_test.file&#34;</span><span class=p>,</span> <span class=n>R_OK</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;access R_OK failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;read access ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>access</span><span class=p>(</span><span class=s>&#34;./access_test.file&#34;</span><span class=p>,</span> <span class=n>W_OK</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;access W_OK failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;write access ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>access</span><span class=p>(</span><span class=s>&#34;./access_test.file&#34;</span><span class=p>,</span> <span class=n>X_OK</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;access X_OK failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;execute access ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// faccessat函数当flag=AT_EACCESS时，采用的是进程的有效用户ID和有效组ID
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>faccessat</span><span class=p>(</span><span class=n>AT_FDCWD</span><span class=p>,</span> <span class=s>&#34;./access_test.file&#34;</span><span class=p>,</span> <span class=n>R_OK</span><span class=p>,</span> <span class=n>AT_EACCESS</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;faccessat R_OK failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;read faccessat ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>faccessat</span><span class=p>(</span><span class=n>AT_FDCWD</span><span class=p>,</span> <span class=s>&#34;./access_test.file&#34;</span><span class=p>,</span> <span class=n>W_OK</span><span class=p>,</span> <span class=n>AT_EACCESS</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;faccessat W_OK failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;write faccessat ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>faccessat</span><span class=p>(</span><span class=n>AT_FDCWD</span><span class=p>,</span> <span class=s>&#34;./access_test.file&#34;</span><span class=p>,</span> <span class=n>X_OK</span><span class=p>,</span> <span class=n>AT_EACCESS</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;faccessat X_OK failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;execute faccessat ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=权限设置函数umask><a href=#%e6%9d%83%e9%99%90%e8%ae%be%e7%bd%ae%e5%87%bd%e6%95%b0umask>权限设置函数umask()</a></h3><p><code>umask</code>函数为进程设置文件模式创建 屏蔽字，并返回之前的值。当进程创建文件时，在文件模式创建屏蔽字中为1的位，在文件mode中的相应位一定被关闭。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>mode_t</span> <span class=nf>umask</span><span class=p>(</span><span class=kt>mode_t</span> <span class=n>cmask</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 返回之前的文件模式创建屏蔽字
</span></span></span></code></pre></div><p>下面验证<code>umask</code>函数的功能：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 屏蔽其他用户的读写执行权限，此时创建的文件的权限应是770
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>umask</span><span class=p>(</span><span class=n>S_IROTH</span> <span class=o>|</span> <span class=n>S_IWOTH</span> <span class=o>|</span> <span class=n>S_IXOTH</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// open函数创建文件时，设置了所有权限即777，但是umask屏蔽之后也应该是770
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>open</span><span class=p>(</span><span class=s>&#34;./umask_test.file&#34;</span><span class=p>,</span> <span class=n>O_WRONLY</span> <span class=o>|</span> <span class=n>O_CREAT</span> <span class=o>|</span> <span class=n>O_TRUNC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>S_IRUSR</span> <span class=o>|</span> <span class=n>S_IWUSR</span> <span class=o>|</span> <span class=n>S_IXUSR</span> <span class=o>|</span> <span class=n>S_IRGRP</span> <span class=o>|</span> <span class=n>S_IWGRP</span> <span class=o>|</span> <span class=n>S_IXGRP</span> <span class=o>|</span>
</span></span><span class=line><span class=cl>                <span class=n>S_IROTH</span> <span class=o>|</span> <span class=n>S_IWOTH</span> <span class=o>|</span> <span class=n>S_IXOTH</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;open failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;create file ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>查看执行结果如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ./umask_test 
</span></span><span class=line><span class=cl>create file ok
</span></span><span class=line><span class=cl>$ ls -l umask_test.file 
</span></span><span class=line><span class=cl>-rwxrwx--- <span class=m>1</span> blduan blduan <span class=m>0</span> Mar  <span class=m>7</span> 18:04 umask_test.file
</span></span></code></pre></div><p>默认的<code>umask</code>值通常在登录时，由shell的启动文件进行设置一次，值为<code>002</code>。</p><p>系统不允许创建文件时，创建的文件拥有执行权限，因此文件的权限最大值为<code>666</code>，但是<code>umask</code>值为<code>002</code>，因此默认情况下文件的权限为<code>644</code>。同理目录的权限为<code>775</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ <span class=nb>umask</span>
</span></span><span class=line><span class=cl><span class=m>000</span>
</span></span><span class=line><span class=cl>$ ls -l .
</span></span><span class=line><span class=cl>drwxrwxr-x <span class=m>2</span> blduan blduan  <span class=m>4096</span> Mar  <span class=m>7</span> 18:16 <span class=nb>umask</span>
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> blduan blduan     <span class=m>0</span> Mar  <span class=m>7</span> 18:16 umask.test
</span></span></code></pre></div><table><thead><tr><th style=text-align:left>屏蔽位</th><th style=text-align:left>含义</th></tr></thead><tbody><tr><td style=text-align:left>0400</td><td style=text-align:left>用户读</td></tr><tr><td style=text-align:left>0200</td><td style=text-align:left>用户写</td></tr><tr><td style=text-align:left>0100</td><td style=text-align:left>用户执行</td></tr><tr><td style=text-align:left>0040</td><td style=text-align:left>组读</td></tr><tr><td style=text-align:left>0020</td><td style=text-align:left>组写</td></tr><tr><td style=text-align:left>0010</td><td style=text-align:left>组执行</td></tr><tr><td style=text-align:left>0004</td><td style=text-align:left>其他读</td></tr><tr><td style=text-align:left>0002</td><td style=text-align:left>其他写</td></tr><tr><td style=text-align:left>0001</td><td style=text-align:left>其他执行</td></tr></tbody></table><h3 id=权限修改函数chmodfchmod和fchmodat><a href=#%e6%9d%83%e9%99%90%e4%bf%ae%e6%94%b9%e5%87%bd%e6%95%b0chmodfchmod%e5%92%8cfchmodat>权限修改函数chmod()、fchmod()和fchmodat()</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>chmod</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>pathname</span><span class=p>,</span> <span class=kt>mode_t</span> <span class=n>mode</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>fchmod</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=kt>mode_t</span> <span class=n>mode</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>fchmodat</span><span class=p>(</span><span class=kt>int</span> <span class=n>dirfd</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>pathname</span><span class=p>,</span> <span class=kt>mode_t</span> <span class=n>mode</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flag</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 成功返回0， 失败返回-1
</span></span></span></code></pre></div><p>这几个函数之间的区别和<code>stat</code>，<code>fstat</code>以及<code>fstatat</code>之间的区别是相同的。根据man文档提示<code>fchmodat</code>现在还不支持<code>flag</code>参数为AT_SYMLINK_NOFOLLOW的情况。</p><p><strong>为了改变一个文件的权限位，进程的有效用户ID必须等于文件的所有者ID，或者进程必须拥有超级用户权限。</strong></p><p><code>chmod</code>系列函数仅会修改i节点最近一次被更改的时间，<code>ls</code>命令显示的是文件内容被修改的时间。因此调用了<code>chmod</code>之后，<code>ls</code>输出结果不变。</p><p>同时指出文件属性结构体<code>stat</code>中的文件时间字段来自与i节点数据。</p><p>参数mode的取值范围如下：</p><table><thead><tr><th style=text-align:left>mode</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>S_ISUID</td><td style=text-align:left>设置用户ID位</td></tr><tr><td style=text-align:left>S_ISGID</td><td style=text-align:left>设置组ID位</td></tr><tr><td style=text-align:left>S_ISVTX</td><td style=text-align:left>保存正文</td></tr><tr><td style=text-align:left>S_IRWXU</td><td style=text-align:left>所有者读写执行</td></tr><tr><td style=text-align:left>S_IRUSR</td><td style=text-align:left>所有者读</td></tr><tr><td style=text-align:left>S_IWUSR</td><td style=text-align:left>所有者写</td></tr><tr><td style=text-align:left>S_IXUSR</td><td style=text-align:left>所有者执行</td></tr><tr><td style=text-align:left>S_IRWXG</td><td style=text-align:left>组读写执行</td></tr><tr><td style=text-align:left>S_IRGRP</td><td style=text-align:left>组读</td></tr><tr><td style=text-align:left>S_IWGRP</td><td style=text-align:left>组写</td></tr><tr><td style=text-align:left>S_IXGRP</td><td style=text-align:left>组执行</td></tr><tr><td style=text-align:left>S_IRWXO</td><td style=text-align:left>其他读写执行</td></tr><tr><td style=text-align:left>S_IROTH</td><td style=text-align:left>其他读</td></tr><tr><td style=text-align:left>S_IWOTH</td><td style=text-align:left>其他写</td></tr><tr><td style=text-align:left>S_IXOTH</td><td style=text-align:left>其他执行</td></tr></tbody></table><p>下面验证<code>chmod</code>函数改变文件权限：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ls -l chmod_test.file 
</span></span><span class=line><span class=cl>-rwxrwxrwx <span class=m>1</span> blduan blduan <span class=m>0</span> Mar  <span class=m>9</span> 07:30 chmod_test.file
</span></span><span class=line><span class=cl>$ ./chmod_test
</span></span><span class=line><span class=cl><span class=nv>euid</span><span class=o>=</span>1000, <span class=nv>egid</span><span class=o>=</span><span class=m>1000</span>
</span></span><span class=line><span class=cl>chmod <span class=m>700</span> ok
</span></span><span class=line><span class=cl>fchmod <span class=m>770</span> ok
</span></span><span class=line><span class=cl>fchmodat <span class=m>777</span> ok
</span></span><span class=line><span class=cl>$ ./chmod_test
</span></span><span class=line><span class=cl><span class=nv>euid</span><span class=o>=</span>1001, <span class=nv>egid</span><span class=o>=</span><span class=m>1001</span>
</span></span><span class=line><span class=cl>chmod failed: Operation not permitted
</span></span><span class=line><span class=cl>fchmod failed: Operation not permitted
</span></span><span class=line><span class=cl>fchmodat failed: Operation not permitted
</span></span><span class=line><span class=cl>$ sudo ./chmod_test
</span></span><span class=line><span class=cl><span class=nv>euid</span><span class=o>=</span>0, <span class=nv>egid</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>chmod <span class=m>700</span> ok
</span></span><span class=line><span class=cl>fchmod <span class=m>770</span> ok
</span></span><span class=line><span class=cl>fchmodat <span class=m>777</span> ok
</span></span></code></pre></div><p>测试代码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 分别验证进程的有效用户ID是文件所有者的ID、不是文件所有者的ID以及是否具有超级权限
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;euid=%d, egid=%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=nf>geteuid</span><span class=p>(),</span> <span class=nf>getegid</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>chmod</span><span class=p>(</span><span class=s>&#34;./chmod_test.file&#34;</span><span class=p>,</span> <span class=n>S_IRWXU</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;chmod failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;chmod 700 ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;./chmod_test.file&#34;</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>fd</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;open failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>fchmod</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>S_IRWXU</span> <span class=o>|</span> <span class=n>S_IRWXG</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;fchmod failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;fchmod 770 ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>fchmodat</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>AT_FDCWD</span><span class=p>,</span> <span class=s>&#34;./chmod_test.file&#34;</span><span class=p>,</span> <span class=n>S_IRWXU</span> <span class=o>|</span> <span class=n>S_IRWXG</span> <span class=o>|</span> <span class=n>S_IRWXO</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;fchmodat failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;fchmodat 777 ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=粘着位><a href=#%e7%b2%98%e7%9d%80%e4%bd%8d>粘着位</a></h3><p><strong>根据之前，想要删除一个文件，只要对文件所在的目录具有写和执行权限，对文件不需要任何权限。</strong></p><p>这样的话，对于共享目录（比如<code>/tmp</code>），是所有用户都拥有读写执行权限。那么这就会存在一个问题，<strong>当前用户可以删除其他用户创建的文件。</strong></p><p>粘着位就是为了解决这个问题，如果对一个目录设置了粘着位，那么用户想要删除或重命名该目录下的文件需要具备以下条件之一才可以：</p><ul><li>该文件的所有者</li><li>目录的拥有者</li><li>是超级用户</li></ul><p>测试用例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 创建共享目录share_dir</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ mkdir share_dir
</span></span><span class=line><span class=cl><span class=c1># 目录的所有者是blduan</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -l
</span></span><span class=line><span class=cl>drwxrwxr-x <span class=m>2</span> blduan blduan <span class=m>4096</span> Mar <span class=m>10</span> 06:41 share_dir
</span></span><span class=line><span class=cl><span class=c1># 共享目录一般所有用户都有读写执行权限</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -l
</span></span><span class=line><span class=cl>drwxrwxrwx <span class=m>2</span> blduan blduan <span class=m>4096</span> Mar <span class=m>10</span> 06:41 share_dir
</span></span><span class=line><span class=cl><span class=c1># 共享目录中创建测试文件test.file</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~/share_dir$ touch test.file
</span></span><span class=line><span class=cl><span class=c1># test.file的所有者是blduan</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~/share_dir$ ls -l
</span></span><span class=line><span class=cl>total <span class=m>0</span>
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> blduan blduan <span class=m>0</span> Mar <span class=m>10</span> 06:42 test.file
</span></span><span class=line><span class=cl><span class=c1># 尝试用其他用户test删除文件test.file</span>
</span></span><span class=line><span class=cl>test@ubuntu:/home/blduan/share_dir$ ls -l
</span></span><span class=line><span class=cl>total <span class=m>0</span>
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> blduan blduan <span class=m>0</span> Mar <span class=m>10</span> 06:42 test.file
</span></span><span class=line><span class=cl>test@ubuntu:/home/blduan/share_dir$ rm -rf test.file 
</span></span><span class=line><span class=cl><span class=c1># 可以看到test用户对share_dir具有读写执行权限，可以删除用户blduan创建的文件test.file</span>
</span></span><span class=line><span class=cl>test@ubuntu:/home/blduan/share_dir$ ls -l
</span></span><span class=line><span class=cl>total <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=c1># 为了解决这个问题，对share_dir设置粘着位</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ chmod o+t share_dir
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -l
</span></span><span class=line><span class=cl>drwxrwxrwt <span class=m>2</span> blduan blduan <span class=m>4096</span> Mar <span class=m>10</span> 06:44 share_dir
</span></span><span class=line><span class=cl><span class=c1># 设置完粘着位，重新在共享目录中创建测试文件test.file1</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~/share_dir$ touch test.file1
</span></span><span class=line><span class=cl>blduan@ubuntu:~/share_dir$ ls -l test.file1 
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> blduan blduan <span class=m>0</span> Mar <span class=m>10</span> 06:46 test.file1
</span></span><span class=line><span class=cl><span class=c1># 接下来再次使用用户test删除文件</span>
</span></span><span class=line><span class=cl>test@ubuntu:/home/blduan/share_dir$ ls -l
</span></span><span class=line><span class=cl>total <span class=m>0</span>
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> blduan blduan <span class=m>0</span> Mar <span class=m>10</span> 06:46 test.file1
</span></span><span class=line><span class=cl><span class=c1># 显然设置了粘着位之后，用户test没有权限删除用户blduan的文件</span>
</span></span><span class=line><span class=cl>test@ubuntu:/home/blduan/share_dir$ rm -rf test.file1 
</span></span><span class=line><span class=cl>rm: cannot remove <span class=s1>&#39;test.file1&#39;</span>: Operation not permitted
</span></span></code></pre></div><h3 id=文件用户更改函数chownfchownfchownat和lchown><a href=#%e6%96%87%e4%bb%b6%e7%94%a8%e6%88%b7%e6%9b%b4%e6%94%b9%e5%87%bd%e6%95%b0chownfchownfchownat%e5%92%8clchown>文件用户更改函数chown()、fchown()、fchownat()和lchown()</a></h3><p><code>chown</code>函数用来更改文件的用户id和组id。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>chown</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>pathname</span><span class=p>,</span> <span class=kt>uid_t</span> <span class=n>owner</span><span class=p>,</span> <span class=kt>gid_t</span> <span class=n>group</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>fchown</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=kt>uid_t</span> <span class=n>owner</span><span class=p>,</span> <span class=kt>gid_t</span> <span class=n>group</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>fchownat</span><span class=p>(</span><span class=kt>int</span> <span class=n>dirfd</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>pathname</span><span class=p>,</span> <span class=kt>uid_t</span> <span class=n>owner</span><span class=p>,</span> <span class=kt>gid_t</span> <span class=n>group</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flag</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>lchown</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>pathname</span><span class=p>,</span> <span class=kt>uid_t</span> <span class=n>owner</span><span class=p>,</span> <span class=kt>gid_t</span> <span class=n>group</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 成功返回0，失败返回-1
</span></span></span></code></pre></div><p>如果参数<code>owner</code>和<code>group</code>中任意一个位-1，则对应的ID不变。</p><p><code>chown</code>系列函数和<code>stat</code>系列函数的区别一致。</p><p>常规情况下，仅有超级用户拥有才能更改一个文件的所有者；</p><p>如果这些函数由非超级权限用户进程调用，则成功返回时，文件的设置用户ID位和设置组ID位会被清楚。</p><p>下面是对<code>chown</code>函数的测试结果</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 创建测试文件chown_test.file</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ touch chown_test.file
</span></span><span class=line><span class=cl><span class=c1># 查看文件的所有者为blduan</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -l chown_test.file 
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> blduan blduan <span class=m>0</span> Mar <span class=m>11</span> 06:11 chown_test.file
</span></span><span class=line><span class=cl><span class=c1># 进程的有效用户ID为1001，等于实际用户ID，即blduan用户。</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ./chown_test 
</span></span><span class=line><span class=cl><span class=nv>euid</span><span class=o>=</span>1000, <span class=nv>egid</span><span class=o>=</span><span class=m>1000</span>
</span></span><span class=line><span class=cl>chown failed
</span></span><span class=line><span class=cl>: Operation not permitted
</span></span><span class=line><span class=cl><span class=c1># 文件所有者未变</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -l chown_test.file 
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> blduan blduan <span class=m>0</span> Mar <span class=m>11</span> 06:11 chown_test.file
</span></span><span class=line><span class=cl><span class=c1># 以超级权限进程修改文件所有者</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ sudo ./chown_test 
</span></span><span class=line><span class=cl><span class=nv>euid</span><span class=o>=</span>0, <span class=nv>egid</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>chown ok
</span></span><span class=line><span class=cl><span class=c1># 文件所有者发生改变</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -l chown_test.file 
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> <span class=nb>test</span> blduan <span class=m>0</span> Mar <span class=m>11</span> 06:11 chown_test.file
</span></span></code></pre></div><p>测试代码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;euid=%d, egid=%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=nf>geteuid</span><span class=p>(),</span> <span class=nf>getegid</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>chown</span><span class=p>(</span><span class=s>&#34;./chown_test.file&#34;</span><span class=p>,</span> <span class=mi>1001</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;chown failed</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;chown ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=文件操作><a href=#%e6%96%87%e4%bb%b6%e6%93%8d%e4%bd%9c>文件操作</a></h2><h3 id=文件长度和空洞><a href=#%e6%96%87%e4%bb%b6%e9%95%bf%e5%ba%a6%e5%92%8c%e7%a9%ba%e6%b4%9e>文件长度和空洞</a></h3><p>文件属性结构体<code>struct stat</code>中的<code>st_size</code>字段表示以字节为单位的文件的长度。此字段仅对普通文件、目录以及符号链接有效。</p><p>普通文件长度可以是0，读文件时会得到文件结束EOF提示。</p><p>目录文件长度通常是一个数（16或512）的整数倍。</p><p>符号链接文件长度是文件名中的实际字节数。</p><p>下面验证文件长度结果</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>blduan@ubuntu:~$ ./file_length_verify ./file_length_test.file ./file_length_test.link ./file_length_test_dir
</span></span><span class=line><span class=cl>./file_length_test.file: <span class=nv>length</span><span class=o>=</span><span class=m>11</span> <span class=c1># 长度为文件内容实际长度</span>
</span></span><span class=line><span class=cl>./file_length_test.link: <span class=nv>length</span><span class=o>=</span><span class=m>21</span> <span class=c1># 长度为指向的文件名的长度</span>
</span></span><span class=line><span class=cl>./file_length_test_dir: <span class=nv>length</span><span class=o>=</span><span class=m>4096</span> <span class=c1># 长度为16或512的整数倍</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -l file_length_test.file 
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> blduan blduan <span class=m>11</span> Mar <span class=m>11</span> 06:58 file_length_test.file
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -l file_length_test.link 
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> blduan blduan <span class=m>21</span> Mar <span class=m>11</span> 06:54 file_length_test.link -&gt; file_length_test.file
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -l ./
</span></span><span class=line><span class=cl>drwxrwxr-x <span class=m>2</span> blduan blduan  <span class=m>4096</span> Mar <span class=m>11</span> 06:54 file_length_test_dir
</span></span></code></pre></div><p>下面是验证代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>stat</span> <span class=n>fileProps</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>argc</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>lstat</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>fileProps</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;lstat failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s: &#34;</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;length=%ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>fileProps</span><span class=p>.</span><span class=n>st_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>文件空洞</strong></p><p>文件空洞的产生原因是设置的偏移量大于文件的实际长度，并且写入了数据。</p><p>Ubuntu20.04上<code>du</code>命令报告的1024字节块的数量，<code>struct stat</code>结构体中的<code>st_blocks</code>计算的是512字节块的数量。<code>ls -s</code>命令和<code>du</code>一致。</p><h3 id=文件截断truncate><a href=#%e6%96%87%e4%bb%b6%e6%88%aa%e6%96%adtruncate>文件截断truncate()</a></h3><p>下面函数支持在文件尾端截断一部分数据。将文件截断为0，可以通过<code>open</code>函数以及O_TRUNC标志实现。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>truncate</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>pathname</span><span class=p>,</span> <span class=kt>off_t</span> <span class=n>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>ftruncate</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=kt>off_t</span> <span class=n>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 成功返回0， 失败返回-1
</span></span></span></code></pre></div><p>如果<code>length</code>参数大于文件长度，则会给文件创建空洞。</p><p>下面测试该函数功能</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//扩展文件生成文件空洞
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>truncate</span><span class=p>(</span><span class=s>&#34;./truncate_test.file&#34;</span><span class=p>,</span> <span class=mi>100000</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;truncate failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;truncate ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>//清空文件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;./truncate_test.file1&#34;</span><span class=p>,</span> <span class=n>O_WRONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>fd</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;open failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;open ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>ftruncate</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;ftruncate failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;ftruncate ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>测试结果如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>blduan@ubuntu:~$ ls -l truncate_test.file*
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> blduan blduan <span class=m>14</span> Mar <span class=m>12</span> 06:41 truncate_test.file
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> blduan blduan <span class=m>11</span> Mar <span class=m>12</span> 06:41 truncate_test.file1
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ./truncate_test 
</span></span><span class=line><span class=cl>truncate ok
</span></span><span class=line><span class=cl>open ok
</span></span><span class=line><span class=cl>ftruncate ok
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -l truncate_test.file*
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> blduan blduan <span class=m>100000</span> Mar <span class=m>12</span> 06:42 truncate_test.file
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> blduan blduan      <span class=m>0</span> Mar <span class=m>12</span> 06:42 truncate_test.file1
</span></span></code></pre></div><h3 id=重命名><a href=#%e9%87%8d%e5%91%bd%e5%90%8d>重命名</a></h3><h2 id=文件系统简介><a href=#%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f%e7%ae%80%e4%bb%8b>文件系统简介</a></h2><p>磁盘分为一个或多个分区。每个分区都包含一个文件系统。</p><p>UFS（文件系统）由自举块、超级块以及多个柱面组组成。柱面组中包含超级块副本、配置信息、i节点位图、块位图以及i节点数组和数据块数组。i节点数组由一些列i节点组成，数据块数组由一些列数据块和目录项组成。</p><p>如下图所示：
<a data-fancybox=gallery href=../%e6%96%87%e4%bb%b6%e5%92%8c%e7%9b%ae%e5%bd%95/%e6%96%87%e4%bb%b6.png><img class=mx-auto alt src=../%e6%96%87%e4%bb%b6%e5%92%8c%e7%9b%ae%e5%bd%95/%e6%96%87%e4%bb%b6.png></a></p><p>由此可见文件系统中，一个文件由目录项、inode和数据块三部分组成：</p><ul><li>目录项： 包含inode节点号和文件名。</li><li>Inode： 文件索引节点，包含文件基础信息以及指向数据块的指针。</li><li>数据块： 包含文件的具体内容。</li></ul><h3 id=inode><a href=#inode>inode</a></h3><p>硬盘的最小存储单位为扇区，大小为512字节。操作系统如果以扇区为单位读取文件，效率太低。而是以块为单位读取文件，块的大小为扇区的整数倍，最常见的大小为4096字节。</p><p>文件数据以块为单位存储在硬盘中。还需要一个地方存储文件的基本信息，比如文件的创建者、时间信息、文件大小等，这种存储文件元信息的区域叫做inode，即索引节点。</p><p>存储inode也会消耗磁盘空间，所以硬盘格式化时，操作系统自动将磁盘分为两个区域。一个是数据区，存放文件数据；另一个是inode区，存放inode所包含的信息。</p><p>每个inode节点的大小一般为128字节或256字节。inode节点的总数，在格式化时就已经确定，一般为没1KB就设置一个inode。</p><p>下面查看ext4文件系统的inode大小</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>blduan@ubuntu:~$ sudo dumpe2fs -h /dev/sda5 <span class=p>|</span> grep <span class=s2>&#34;Inode size&#34;</span>
</span></span><span class=line><span class=cl>dumpe2fs 1.45.5 <span class=o>(</span>07-Jan-2020<span class=o>)</span>
</span></span><span class=line><span class=cl>Inode size:	          <span class=m>256</span>
</span></span></code></pre></div><p><strong>由于每个文件都必须有一个inode，因此就有可能发生，磁盘空间还有但是inode已经用光的情况。</strong></p><p>每个inode都有一个号码，操作系统用inode号码来识别不同的文件。查看当前文件的inode编号如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>blduan@ubuntu:~$ ls -i stat_test
</span></span><span class=line><span class=cl><span class=m>1973604</span> stat_test
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ stat stat_test
</span></span><span class=line><span class=cl>  File: stat_test
</span></span><span class=line><span class=cl>  Size: <span class=m>17160</span>     	Blocks: <span class=m>40</span>         IO Block: <span class=m>4096</span>   regular file
</span></span><span class=line><span class=cl>Device: 805h/2053d	Inode: <span class=m>1973604</span>     Links: <span class=m>1</span>
</span></span><span class=line><span class=cl>Access: <span class=o>(</span>0775/-rwxrwxr-x<span class=o>)</span>  Uid: <span class=o>(</span> 1000/  blduan<span class=o>)</span>   Gid: <span class=o>(</span> 1000/  blduan<span class=o>)</span>
</span></span><span class=line><span class=cl>Access: 2022-03-12 18:37:44.124404379 -0800
</span></span><span class=line><span class=cl>Modify: 2022-03-07 07:16:59.342125333 -0800
</span></span><span class=line><span class=cl>Change: 2022-03-07 07:16:59.342125333 -0800
</span></span><span class=line><span class=cl> Birth: -
</span></span></code></pre></div><p>inode包含的文件相关信息主要有文件类型、文件访问权限位、文件长度和指向文件的指针。<code>stat</code>结构的大多信息都取自i节点。</p><h3 id=目录项><a href=#%e7%9b%ae%e5%bd%95%e9%a1%b9>目录项</a></h3><p>Linux系统中，目录也是一种文件。打开目录，实际上就是打开目录文件。</p><p>目录文件的结构非常简单，就是一系列目录项的列表。每个目录项由两部分组成：所包含文件的文件名、该文件名对应的inode编号。</p><p>下面可以查看目录文件中包含了哪些inode信息</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># test-link目录文件中包含一条目录项为test。</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -i test-link/
</span></span><span class=line><span class=cl><span class=m>1973383</span> <span class=nb>test</span>
</span></span></code></pre></div><h2 id=硬链接和符号链接><a href=#%e7%a1%ac%e9%93%be%e6%8e%a5%e5%92%8c%e7%ac%a6%e5%8f%b7%e9%93%be%e6%8e%a5>硬链接和符号链接</a></h2><h3 id=硬链接><a href=#%e7%a1%ac%e9%93%be%e6%8e%a5>硬链接</a></h3><p>一般情况下，文件名和inode编号是一一对应的，每个inode编号对应一个文件名。</p><p>但是Linux系统允许多个文件名指向同一个inode编号。这意味着可以通过不同的文件名访问同样的内容。</p><p>对文件内容的修改会影响到所有文件名，但是删除一个文件名，不会影响另一个文件名的访问，这种情况就是硬链接。</p><p>可以使用命令<code>ln source_file target_file</code>创建硬链接。</p><p>创建完成之后，会在数据块中创建一条新的目录项，目录项中的指向inode编号和源文件的相同，都指向同一个inode。inode信息中有一项为链接数，记录指向该inode的文件名总数，此时会+1。</p><p>创建目录时，默认会生成两个目录项：<code>.</code>和<code>..</code>。前者的inode编号就是当前目录的inode编号，等同于当前目录的硬链接；后者的inode编号就是当前目录的父目录的inode编号，等同于父目录的硬链接。因此任何一个目录的硬链接数总是等于2（父目录对其的硬链接和当前目录下<code>.</code>的硬链接）+子目录的总数。</p><p>叶目录（不包含子目录的目录）至少存在2个硬链接，一个是父目录对其的硬链接，一个是该目录下的<code>.</code>产生的硬链接。</p><p>父目录至少存在3个硬链接，一个是其父目录对其的硬链接，一个是其目录中存在的<code>.</code>,还有就是其子目录中的<code>..</code>。</p><p>下面的函数可以用来创建硬链接:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>link</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>oldpath</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>newpath</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;           /* Definition of AT_* constants */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>linkat</span><span class=p>(</span><span class=kt>int</span> <span class=n>olddirfd</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>oldpath</span><span class=p>,</span> <span class=kt>int</span> <span class=n>newdirfd</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>newpath</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 成功返回0， 失败返回-1
</span></span></span></code></pre></div><p>这两个文件创建一个新的目录项<code>newpath</code>，引用现有文件<code>oldpath</code>。如果<code>newpath</code>存在，则返回出错。<code>newpath</code>路径名中的目录必须存在。</p><p><code>linkat</code>函数的<code>olddirfd</code>和<code>newdirfd</code>参数是当使用相对目录时给出参考位置的，如果值为<code>AT_FDCWD</code>则计算当前工作目录的相对位置。</p><p><code>linkat</code>函数的<code>flags</code>和其他函数的一致，都是根据<code>AT_SYMLINK_FOLLOW</code>标志来决定是链接本身还是链接指向的文件。</p><p><strong>创建目录项和增加链接计数应当是一个原子操作。</strong></p><p>下面验证<code>link</code>函数功能</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>link</span><span class=p>(</span><span class=s>&#34;./link_test.file&#34;</span><span class=p>,</span> <span class=s>&#34;./link_test.lnk&#34;</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;link failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;link ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>olddirfd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;.&#34;</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>newdirfd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;.&#34;</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>linkat</span><span class=p>(</span><span class=n>olddirfd</span><span class=p>,</span> <span class=s>&#34;./link_test.file1&#34;</span><span class=p>,</span> <span class=n>newdirfd</span><span class=p>,</span> <span class=s>&#34;./link/link_test1.lnk&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>AT_SYMLINK_FOLLOW</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;linkat error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;linkat ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>close</span><span class=p>(</span><span class=n>olddirfd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>close</span><span class=p>(</span><span class=n>newdirfd</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>执行结果如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>blduan@ubuntu:~$ ./link_test 
</span></span><span class=line><span class=cl>link ok
</span></span><span class=line><span class=cl>linkat ok
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -i link_test.file link_test.lnk
</span></span><span class=line><span class=cl><span class=m>1973331</span> link_test.file  <span class=m>1973331</span> link_test.lnk
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -i link_test.file1 ./link/link_test1.lnk 
</span></span><span class=line><span class=cl><span class=m>1973391</span> ./link/link_test1.lnk  <span class=m>1973391</span> link_test.file1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ stat link_test.file1 
</span></span><span class=line><span class=cl>  File: link_test.file1
</span></span><span class=line><span class=cl>  Size: <span class=m>0</span>         	Blocks: <span class=m>0</span>          IO Block: <span class=m>4096</span>   regular empty file
</span></span><span class=line><span class=cl>Device: 805h/2053d	Inode: <span class=m>1973391</span>     Links: <span class=m>2</span>
</span></span><span class=line><span class=cl>Access: <span class=o>(</span>0664/-rw-rw-r--<span class=o>)</span>  Uid: <span class=o>(</span> 1000/  blduan<span class=o>)</span>   Gid: <span class=o>(</span> 1000/  blduan<span class=o>)</span>
</span></span><span class=line><span class=cl>Access: 2022-03-13 03:26:33.572857628 -0700
</span></span><span class=line><span class=cl>Modify: 2022-03-13 03:26:33.572857628 -0700
</span></span><span class=line><span class=cl>Change: 2022-03-13 03:27:10.688749607 -0700
</span></span><span class=line><span class=cl> Birth: -
</span></span></code></pre></div><p>删除一个现有的目录项可以调用<code>unlink</code>函数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>unlink</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>pathname</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>unlinkat</span><span class=p>(</span><span class=kt>int</span> <span class=n>dirfd</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>pathname</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flag</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 成功返回0， 失败返回-1
</span></span></span></code></pre></div><p>这两个函数删除目录项，同时使<code>pathname</code>指向的文件的链接数-1。</p><p>为了解除对文件的链接，必须对包含该目录项的目录具有写和执行权限。</p><p>如果对该目录设置了粘着位，则必须对该目录具有写权限，并且具备以下三个条件之一</p><ul><li>拥有该文件</li><li>拥有该目录</li><li>超级用户权限</li></ul><p>如果<code>pathname</code>为符号链接，<code>unlink</code>函数删除该符号链接，而不是符号链接指向的文件。</p><p><strong>只有当文件的链接计数为0时，文件内容才可被删除。只要有进程打开了文件，其内容也不可被删除。</strong></p><p>关闭一个文件时，内核首先去检查打开该文件的进程个数；如果这个计数达到0，内核再去检查其链接计数；如果计数也是0，那么内核就会删除该文件的内容。</p><p>下面验证内核这个功能：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;./unlink_test.file&#34;</span><span class=p>,</span> <span class=n>O_RDWR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>fd</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;open failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;open ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>unlink</span><span class=p>(</span><span class=s>&#34;./unlink_test.file&#34;</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;unlink failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;unlink ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>sleep</span><span class=p>(</span><span class=mi>15</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;done</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>测试结果如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 查看测试文件unlink_test.file的大小为16394</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -l unlink_test.file 
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> blduan blduan <span class=m>16394</span> Mar <span class=m>13</span> 03:47 unlink_test.file
</span></span><span class=line><span class=cl><span class=c1># unlink_test.file大小占20个1k字节块</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ du -s unlink_test.file 
</span></span><span class=line><span class=cl>20	unlink_test.file
</span></span><span class=line><span class=cl><span class=c1># 下面可以看到已使用的1k字节块数为13456940</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ df ~
</span></span><span class=line><span class=cl>Filesystem     1K-blocks     Used Available Use% Mounted on
</span></span><span class=line><span class=cl>/dev/sda5       <span class=m>50824704</span> <span class=m>13456940</span>  <span class=m>34756308</span>  28% /
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ./unlink_test <span class=p>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>1<span class=o>]</span> <span class=m>13626</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ open ok
</span></span><span class=line><span class=cl>unlink ok
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># unlink接触链接之后目录项已经被删除了，但是文件内容由于进程没有关闭文件还存在，因为并没有释放1k字节块</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -l unlink_test.file 
</span></span><span class=line><span class=cl>ls: cannot access <span class=s1>&#39;unlink_test.file&#39;</span>: No such file or directory
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ df ~
</span></span><span class=line><span class=cl>Filesystem     1K-blocks     Used Available Use% Mounted on
</span></span><span class=line><span class=cl>/dev/sda5       <span class=m>50824704</span> <span class=m>13456940</span>  <span class=m>34756308</span>  28% /
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ <span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>1<span class=o>]</span>+  Done                    ./unlink_test、
</span></span><span class=line><span class=cl><span class=c1># 进程退出时关闭了打开的文件，内核同时释放了文件内容</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ df ~
</span></span><span class=line><span class=cl>Filesystem     1K-blocks     Used Available Use% Mounted on
</span></span><span class=line><span class=cl>/dev/sda5       <span class=m>50824704</span> <span class=m>13456920</span>  <span class=m>34756328</span>  28% /
</span></span></code></pre></div><p><strong>unlink的这种特性可以使即使进程中途崩溃，其所创建的临时文件也不会遗留下来</strong></p><p><code>remove</code>函数也可以解除对一个文件或目录的链接。对于文件和<code>unlink</code>函数的功能一致，对于目录和<code>rmdir</code>相同。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>remove</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>pathname</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 成功返回0， 失败返回-1
</span></span></span></code></pre></div><h3 id=符号链接><a href=#%e7%ac%a6%e5%8f%b7%e9%93%be%e6%8e%a5>符号链接</a></h3><p>符号链接是对一个文件的间接引用，和硬链接不同，硬链接是直接指向文件的i节点。</p><p>符号链接文件拥有自己的目录项、i节点以及数据块。只是数据块中的文件内容是目标文件的路径名。</p><p>符号链接是为了避免硬链接的以下限制：</p><ul><li>硬链接通常要求链接和文件存在同一文件系统中。</li><li>只有超级用户才能创建目录的硬链接。（Ubuntu20.04不允许对目录创建硬链接）</li></ul><p>对符号链接以及它指向何种对象并没有文件系统限制，任何用户都可以创建指向目录的符号链接。</p><p>当使用以名字引用文件的函数时，应当了解该函数是否处理符号链接。支持符号链接的函数默认会跟随符号链接到指向的文件。</p><p>对目录的符号链接可能会在文件系统中引入循环，但是<code>ls</code>命令是不会跟随符号链接的，同时也有<code>unlink</code>函数也不跟随符号链接，可以很方便的用来删除符号链接。</p><p>可以使用<code>symlink</code>和<code>symlinkat</code>函数创建符号链接：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>symlink</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>actualpath</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>sympath</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>symlinkat</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>actualpath</span><span class=p>,</span> <span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>sympath</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 成功返回0 失败返回-1
</span></span></span></code></pre></div><p>因为<code>open</code>函数会跟踪符号链接，因此提供下面两个函数打开链接本身，并读取该链接中的名字。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>ssize_t</span> <span class=nf>readlink</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>pathname</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>bufsiz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;           /* Definition of AT_* constants */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>ssize_t</span> <span class=nf>readlinkat</span><span class=p>(</span><span class=kt>int</span> <span class=n>dirfd</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>pathname</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>bufsiz</span><span class=p>);</span>
</span></span></code></pre></div><p>这两个函数组合了<code>open, read和close</code>的所有操作，如果函数执行成功返回读入<code>buf</code>的字节数。</p><p>下面验证这两个函数功能：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>symlink</span><span class=p>(</span><span class=s>&#34;./symlink_test.file&#34;</span><span class=p>,</span> <span class=s>&#34;./symlink_test.link&#34;</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;symlink error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;symlink ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>256</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>readlink</span><span class=p>(</span><span class=s>&#34;./symlink_test.link&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;readlink failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;readlink ok, content is %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>执行结果如下所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>blduan@ubuntu:~$ ls -l symlink_test.file 
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> blduan blduan <span class=m>0</span> Mar <span class=m>13</span> 06:48 symlink_test.file
</span></span><span class=line><span class=cl><span class=c1># 链接文件的内容是其指向的目标文件的路径名</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ./symlink_test 
</span></span><span class=line><span class=cl>symlink ok
</span></span><span class=line><span class=cl>readlink ok, content is ./symlink_test.file
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -l symlink_test.link 
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> blduan blduan <span class=m>19</span> Mar <span class=m>13</span> 06:48 symlink_test.link -&gt; ./symlink_test.file
</span></span></code></pre></div><h2 id=文件时间><a href=#%e6%96%87%e4%bb%b6%e6%97%b6%e9%97%b4>文件时间</a></h2><p>文件的属性结构体对每个文件维护3个时间字段。</p><table><thead><tr><th style=text-align:left>字段</th><th style=text-align:center>说明</th><th style=text-align:left>例子</th><th style=text-align:left>ls选项</th></tr></thead><tbody><tr><td style=text-align:left>st_atime</td><td style=text-align:center>文件数据的最后访问时间</td><td style=text-align:left>read</td><td style=text-align:left>-u</td></tr><tr><td style=text-align:left>st_mtime</td><td style=text-align:center>文件数据的最后修改时间</td><td style=text-align:left>write</td><td style=text-align:left>默认</td></tr><tr><td style=text-align:left>st_ctime</td><td style=text-align:center>i节点状态的最后修改时间</td><td style=text-align:left>chmod、chown</td><td style=text-align:left>-c</td></tr></tbody></table><p>很多操作都会影响到i节点，比如更改文件的访问权限、更改用户ID、更改链接数，这些操作不会影响文件数据。</p><p>系统并不维护对i节点的最后访问时间，比如<code>access</code>和<code>stat</code>函数并不会更改3个时间中的任意一个。</p><p><strong>目录是包含目录项（文件名和i节点编号）的文件，增加、删除和修改目录项会影响到它所在目录相关的3个时间。</strong></p><p>下面是各种函数对访问、修改和状态更改时间的作用：
<a data-fancybox=gallery href=../%e6%96%87%e4%bb%b6%e5%92%8c%e7%9b%ae%e5%bd%95/%e5%bd%b1%e5%93%8d%e6%96%87%e4%bb%b6%e6%97%b6%e9%97%b4%e7%9a%84%e5%87%bd%e6%95%b0.png><img class=mx-auto alt src=../%e6%96%87%e4%bb%b6%e5%92%8c%e7%9b%ae%e5%bd%95/%e5%bd%b1%e5%93%8d%e6%96%87%e4%bb%b6%e6%97%b6%e9%97%b4%e7%9a%84%e5%87%bd%e6%95%b0.png></a></p><hr><p>文件的访问和修改时间可以使用函数<code>futimens</code>和<code>utimensat</code>来修改</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>futimens</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=k>const</span> <span class=k>struct</span> <span class=n>timespec</span> <span class=n>times</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>utimensat</span><span class=p>(</span><span class=kt>int</span> <span class=n>dirfd</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>path</span><span class=p>,</span> <span class=k>const</span> <span class=k>struct</span> <span class=n>timespec</span> <span class=n>times</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=kt>int</span> <span class=n>flag</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 成功返回0， 失败返回-1
</span></span></span></code></pre></div><p><code>times</code>数组的第一个元素表示访问时间，第二个元素表示修改时间。</p><p>如果<code>timespec</code>结构之一的<code>tv_nsec</code>字段具有特殊值UTIME_NOW，则相应的文件时间戳设置为当前时间。</p><p>如果<code>timespec</code>结构之一的<code>tv_nsec</code>字段具有特殊值UTIME_OMIT，则相应的文件时间戳保持不变。</p><p>在这两种情况下，相应的<code>tv_sec</code>的值将被忽略。</p><p><strong>权限检查</strong></p><p>要将两个文件时间戳都设置为当前时间（即<code>times</code>为 NULL，或者两个<code>tv_nsec</code>字段都指定 UTIME_NOW），必须具有以下条件之一：</p><ol><li>进程必须对文件具有写访问权、进程的有效用户ID必须与文件的所有者匹配</li><li>进程具有超级用户权限</li></ol><p>当<code>tv_nsec</code>的值为UTIME_OMIT时，文件的相应时间戳不变，并且不会进行权限检查。</p><p>下面测试修改文件时间：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/time.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>stat</span> <span class=n>statbuf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>timespec</span> <span class=n>times</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>argc</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>stat</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>statbuf</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;stat failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>O_RDWR</span> <span class=o>|</span> <span class=n>O_TRUNC</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;open failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>times</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>tv_sec</span> <span class=o>=</span> <span class=n>statbuf</span><span class=p>.</span><span class=n>st_atime</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>times</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=n>tv_sec</span> <span class=o>=</span> <span class=n>statbuf</span><span class=p>.</span><span class=n>st_mtime</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>futimens</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>times</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;futimens failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>测试结果如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 查看文件长度和最后修改时间</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -l utimens_test.file 
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> blduan blduan <span class=m>13</span> Mar <span class=m>14</span> 08:34 utimens_test.file
</span></span><span class=line><span class=cl><span class=c1># 查看最后访问时间</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -lu utimens_test.file 
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> blduan blduan <span class=m>13</span> Mar <span class=m>14</span> 08:34 utimens_test.file
</span></span><span class=line><span class=cl><span class=c1># 查看当前时间</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ date
</span></span><span class=line><span class=cl>Mon <span class=m>14</span> Mar <span class=m>2022</span> 08:35:10 AM PDT
</span></span><span class=line><span class=cl><span class=c1># 执行程序清空文件</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ./utimens_test utimens_test.file 
</span></span><span class=line><span class=cl><span class=c1># 查看清空后的文件长度和最后修改时间，长度变为0，时间未变</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -l utimens_test.file 
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> blduan blduan <span class=m>0</span> Mar <span class=m>14</span> 08:34 utimens_test.file
</span></span><span class=line><span class=cl><span class=c1># 查看最后访问时间未变</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -lu utimens_test.file 
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> blduan blduan <span class=m>0</span> Mar <span class=m>14</span> 08:34 utimens_test.file
</span></span><span class=line><span class=cl><span class=c1># 查看状态修改时间发生变化</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -lc utimens_test.file 
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> blduan blduan <span class=m>0</span> Mar <span class=m>14</span> 08:35 utimens_test.file
</span></span><span class=line><span class=cl>blduan@ubuntu:~/Documents/code_snippet/4_chapter$ 
</span></span></code></pre></div><h2 id=目录><a href=#%e7%9b%ae%e5%bd%95>目录</a></h2><p>在Linux中目录是一个文件，文件的内容一系列i节点编号和对应的文件名。</p><h3 id=创建和删除目录><a href=#%e5%88%9b%e5%bb%ba%e5%92%8c%e5%88%a0%e9%99%a4%e7%9b%ae%e5%bd%95>创建和删除目录</a></h3><p>下面的函数用来创建和删除目录：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>mkdir</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>pathname</span><span class=p>,</span> <span class=kt>mode_t</span> <span class=n>mode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;           /* Definition of AT_* constants */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>mkdirat</span><span class=p>(</span><span class=kt>int</span> <span class=n>dirfd</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>pathname</span><span class=p>,</span> <span class=kt>mode_t</span> <span class=n>mode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>rmdir</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>pathname</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 成功返回0，失败返回-1
</span></span></span></code></pre></div><p><code>mkdir</code>和<code>mkdirat</code>函数会创建空目录文件，文件中的<code>.</code>和<code>..</code>目录项都是自动创建的。所指定的文件访问权限<code>mode</code>由进程的文件模式创建屏蔽字修改。</p><p>对于目录通常最少需要指定一个可执行权限，用来访问目录中的文件名。</p><p>目录的所有者ID为进程的有效用户ID，目录的组ID为进程的有效组ID。</p><p>当<code>fd</code>参数值为AT_FDCWD或<code>pathname</code>为绝对路径时，<code>mkdirat</code>和<code>mkdir</code>完全一致。</p><p><code>rmdir</code>函数可以删除空目录，空目录只包含<code>.</code>和<code>..</code>两项。</p><p>如果调用<code>rmdir</code>函数使目录的链接计数成为0，并且也没有其他进程打开此目录，则释放目录占用的空间。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 屏蔽组执行权限
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>umask</span><span class=p>(</span><span class=n>S_IXGRP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>mkdir</span><span class=p>(</span><span class=s>&#34;./mkdir_test1&#34;</span><span class=p>,</span> <span class=n>S_IRWXU</span> <span class=o>|</span> <span class=n>S_IRWXG</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;mkdir error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;mkdir ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//屏蔽其他用户执行权限
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>umask</span><span class=p>(</span><span class=n>S_IXOTH</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>mkdirat</span><span class=p>(</span><span class=n>AT_FDCWD</span><span class=p>,</span> <span class=s>&#34;./mkdir_test2&#34;</span><span class=p>,</span> <span class=n>S_IRWXU</span> <span class=o>|</span> <span class=n>S_IRWXG</span> <span class=o>|</span> <span class=n>S_IRWXO</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;mkdirat error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;mkdirat ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>sleep</span><span class=p>(</span><span class=mi>30</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>rmdir</span><span class=p>(</span><span class=s>&#34;./mkdir_test1&#34;</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;rmdir error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;rmdir ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>执行结果如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>blduan@ubuntu:~/Documents/code_snippet/4_chapter$ ./mkdir_test <span class=p>&amp;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>1<span class=o>]</span> <span class=m>25442</span>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ mkdir ok
</span></span><span class=line><span class=cl>mkdirat ok
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -ld mkdir_test1
</span></span><span class=line><span class=cl>drwxrw---- <span class=m>2</span> blduan blduan <span class=m>4096</span> Mar <span class=m>15</span> 07:42 mkdir_test1
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -ld mkdir_test2
</span></span><span class=line><span class=cl>drwxrwxrw- <span class=m>2</span> blduan blduan <span class=m>4096</span> Mar <span class=m>15</span> 07:42 mkdir_test2
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ rmdir ok
</span></span><span class=line><span class=cl>blduan@ubuntu:~$ ls -ld mkdir_test1
</span></span><span class=line><span class=cl>ls: cannot access <span class=s1>&#39;mkdir_test1&#39;</span>: No such file or directory
</span></span></code></pre></div><h3 id=读目录><a href=#%e8%af%bb%e7%9b%ae%e5%bd%95>读目录</a></h3><h3 id=进程的工作目录><a href=#%e8%bf%9b%e7%a8%8b%e7%9a%84%e5%b7%a5%e4%bd%9c%e7%9b%ae%e5%bd%95>进程的工作目录</a></h3><p>每个进程都有一个工作目录，该目录是当前进程中所有相对目录的起点。</p><p>默认情况下，进程的工作目录由登陆时/etc/passwd文件中用户登陆项的第6个字段决定。如<code>blduan:x:1000:1000:blduan,,,:/home/blduan:/bin/bash</code></p><p>进程可以调用<code>chdir</code>和<code>fchdir</code>函数更改当前工作目录：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>chdir</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>pathname</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>fchdir</span><span class=p>(</span><span class=kt>int</span> <span class=n>dirfd</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 成功返回0， 失败返回-1
</span></span></span></code></pre></div><p><strong>当前工作目录是进程的一个属性，仅影响调用chdir或fchdir的进程自身。</strong></p><p>由于内核仅为进程维护一个指向其工作目录的i节点的指针，没有工作目录路径，因此需要提供一个函数来获取进程的当前工作目录。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>char</span><span class=o>*</span> <span class=nf>getcwd</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>buf</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 成功返回buf，失败返回NULL
</span></span></span></code></pre></div><p>下面验证函数功能：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;limits.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/limits.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span><span class=o>*</span> <span class=n>buf</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=nf>malloc</span><span class=p>(</span><span class=n>NAME_MAX</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>buf</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>memset</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=n>NAME_MAX</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>getcwd</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=n>NAME_MAX</span> <span class=o>+</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;current directory is %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;will change work directory is /tmp</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>chdir</span><span class=p>(</span><span class=s>&#34;/tmp&#34;</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;chdir failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;chdir ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>memset</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=n>NAME_MAX</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>getcwd</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=n>NAME_MAX</span> <span class=o>+</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;current directory is %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;will change work directory /home/blduan</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;/home/blduan&#34;</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>fchdir</span><span class=p>(</span><span class=n>fd</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;fchdir failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;fchdir ok</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>memset</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=n>NAME_MAX</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>getcwd</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=n>NAME_MAX</span> <span class=o>+</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;current directory is %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nf>free</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 执行结果如下
</span></span></span><span class=line><span class=cl><span class=c1>// current directory is /home/blduan/Documents/projects/code_snippet/4_chapter
</span></span></span><span class=line><span class=cl><span class=c1>// will change work directory is /tmp
</span></span></span><span class=line><span class=cl><span class=c1>// chdir ok
</span></span></span><span class=line><span class=cl><span class=c1>// current directory is /tmp
</span></span></span><span class=line><span class=cl><span class=c1>// will change work directory /home/blduan
</span></span></span><span class=line><span class=cl><span class=c1>// fchdir ok
</span></span></span><span class=line><span class=cl><span class=c1>// current directory is /home/blduan
</span></span></span></code></pre></div><p>当程序需要返回其工作起点目录时，可以提前用<code>getcwd</code>或<code>open</code>函数分别保存目录名或文件描述符，之后用<code>chdir</code>或<code>fchdir</code>切换目录。</p><h2 id=设备特殊文件><a href=#%e8%ae%be%e5%a4%87%e7%89%b9%e6%ae%8a%e6%96%87%e4%bb%b6>设备特殊文件</a></h2></div><div class=post-archive><ul class=post-copyright><li><strong>原文作者：</strong><a rel=author href=https://DBL2017.github.io/>生如夏花</a></li><li style=word-break:break-all><strong>原文链接：</strong><a href=https://DBL2017.github.io/post/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/apue/%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95/>https://DBL2017.github.io/post/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/apue/%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95/</a></li><li><strong>版权声明：</strong>本作品采用<a rel=license href=https://creativecommons.org/licenses/by-nc-nd/4.0/>知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li></ul></div><br><div class=post-archive><h2>相关文章</h2><ul class=listing><li><a href=/post/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/apue/%E6%96%87%E4%BB%B6io/>文件IO</a></li></ul></div><div class="post-meta meta-tags"><ul class=clearfix><li><a href=/tags/apue>APUE</a></li><li><a href=/tags/%E6%96%87%E4%BB%B6>文件</a></li><li><a href=/tags/%E7%9B%AE%E5%BD%95>目录</a></li><li><a href=/tags/%E7%B2%98%E7%9D%80%E4%BD%8D>粘着位</a></li><li><a href=/tags/%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90>文件权限</a></li><li><a href=/tags/%E6%9C%89%E6%95%88%E7%94%A8%E6%88%B7>有效用户</a></li><li><a href=/tags/%E9%99%84%E5%B1%9E%E7%BB%84>附属组</a></li><li><a href=/tags/%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90%E6%A3%80%E6%B5%8B>访问权限检测</a></li><li><a href=/tags/%E6%9C%89%E6%95%88%E7%BB%84>有效组</a></li></ul></div></article><div class="post bg-white"><script src=https://utteranc.es/client.js repo=DBL2017/DBL2017.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></div></div><div class=content-right><div class=sidebar><section class=widget><form id=form-search action=https://DBL2017.github.io/search/ method=get accept-charset=utf-8 _lpchecked=1><input type=text name=q maxlength=20 placeholder=请输入查找关键字 required>
<button type=submit class=submit title=提交>
<svg t="1714448321870" class="icon" style="width:22px;height:22px" viewBox="0 0 1024 1024" p-id="1771" width="200" height="200"><path d="M781.9264 691.1232l236.928 236.9216-90.816 90.8032-236.9152-236.9216c-72.032 53.3568-161.184 84.9088-257.7088 84.9088C194.048 866.8352.0 672.7872.0 433.408.0 194.048 194.048.0 433.4144.0c239.3728.0 433.4208 194.048 433.4208 433.4144.0 96.5248-31.552 185.6768-84.9088 257.7088zm-348.512 47.2896c168.448.0 304.9984-136.5504 304.9984-304.9984s-136.5504-304.992-304.9984-304.992-304.992 136.5504-304.992 304.9856c0 168.448 136.5504 304.9984 304.992 304.9984z" fill="#4A4A4A" p-id="1772"/></svg></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=https://DBL2017.github.io/post/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/ubuntu18%E6%B0%B8%E4%B9%85%E4%BF%AE%E6%94%B9%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3%E5%90%8D%E7%A7%B0/ title=Ubuntu18永久修改网络接口名称>Ubuntu18永久修改网络接口名称</a></li><li><a href=https://DBL2017.github.io/post/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/latex/latex%E4%B9%8Bdocumentclass/ title=LaTeX之documentclass>LaTeX之documentclass</a></li><li><a href=https://DBL2017.github.io/post/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/latex/latex%E4%B9%8Bctex%E5%AE%8F%E9%9B%86%E4%B9%8B%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3%E7%B1%BB/ title=LaTeX之CTeX宏集之中文文档类>LaTeX之CTeX宏集之中文文档类</a></li><li><a href=https://DBL2017.github.io/post/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/latex/latex%E4%B9%8B%E4%B8%AD%E6%96%87%E6%94%AF%E6%8C%81/ title=LaTex之中文支持>LaTex之中文支持</a></li><li><a href=https://DBL2017.github.io/post/%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE/dibbler-server%E7%9A%84dhcpv6-pd%E5%A6%82%E4%BD%95%E5%88%86%E9%85%8D56%E4%BD%8D%E5%89%8D%E7%BC%80/ title=dibbler-server的DHCPv6-PD如何分配56位前缀>dibbler-server的DHCPv6-PD如何分配56位前缀</a></li><li><a href=https://DBL2017.github.io/post/%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE/%E7%BD%91%E7%BB%9C%E5%B1%82/tcp%E4%B9%8Bmss%E5%AD%97%E6%AE%B5%E5%A4%87%E6%B3%A8/ title=TCP之MSS字段备注>TCP之MSS字段备注</a></li><li><a href=https://DBL2017.github.io/post/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8Bcontainer_of/ title=内核数据结构之container_of>内核数据结构之container_of</a></li><li><a href=https://DBL2017.github.io/post/%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE/eve-ng/eve-ng%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/ title=EVE-NG环境搭建>EVE-NG环境搭建</a></li><li><a href=https://DBL2017.github.io/post/%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE/ns-3/ns-3%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/ title=NS-3环境搭建>NS-3环境搭建</a></li><li><a href=https://DBL2017.github.io/post/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/makefile/makefile%E5%87%BD%E6%95%B0/ title=Makefile函数>Makefile函数</a></li></ul></section><section class=widget><h3 class=widget-title><a href=/categories/>分类</a></h3><ul class=widget-list><li><a href=https://DBL2017.github.io/categories/%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE/>传输协议 (16)</a></li><li><a href=https://DBL2017.github.io/categories/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/>工具使用 (23)</a></li><li><a href=https://DBL2017.github.io/categories/%E5%BC%80%E6%BA%90%E4%B8%89%E6%96%B9/>开源三方 (2)</a></li><li><a href=https://DBL2017.github.io/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/>操作系统 (12)</a></li><li><a href=https://DBL2017.github.io/categories/%E6%95%B0%E5%AD%97%E5%AE%89%E5%85%A8/>数字安全 (4)</a></li><li><a href=https://DBL2017.github.io/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/>数据结构和算法 (5)</a></li><li><a href=https://DBL2017.github.io/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/>编程语言 (13)</a></li><li><a href=https://DBL2017.github.io/categories/%E7%BD%91%E7%BB%9C%E5%B7%A5%E7%A8%8B%E5%B8%88/>网络工程师 (4)</a></li><li><a href=https://DBL2017.github.io/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/>读书笔记 (56)</a></li><li><a href=https://DBL2017.github.io/categories/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/>问题排查 (5)</a></li><li><a href=https://DBL2017.github.io/categories/%E9%BB%98%E8%AE%A4/>默认 (2)</a></li></ul></section><section class=widget><h3 class=widget-title>友情链接</h3><ul class=widget-list><li><a target=_blank href=https://mermaid.live/ title=Mermaid>Mermaid 编辑</a></li><li><a target=_blank href=https://excalidraw.com/ title=EXCALIDRAW>Excalidraw 绘图</a></li><li><a target=_blank href=https://git-scm.com/docs title=Git命令参考手册>Git命令参考手册</a></li><li><a target=_blank href=https://www.gnu.org/software/make/manual/make.html title="GNU make官方文档">GNU make官方文档</a></li><li><a target=_blank href=https://www.emojiall.com/ title=Emojiall表情网站>Emojiall表情网站</a></li></ul></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=https://DBL2017.github.io/index.xml>文章 RSS</a></li></ul></section></div></div></div><div class=container-footer><footer id=footer><div>&copy; 2025 <a href=https://DBL2017.github.io/>生如夏花 By
生如夏花</a>
| <a rel=nofollow target=_blank href=http://beian.miit.gov.cn/>广电总局</a></div><br><div><div class=github-badge><a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered
by</span><span class="badge-value bg-blue">Hugo</span></a></div><div class=github-badge><a href=https://DBL2017.github.io/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">生如夏花</span></a></div><div class=github-badge><a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a></div></div></footer><script src=/js/jquery.fancybox.min.min.7fa821ee946e58947030e5d007d358378119205e16b74ab4d0c60560a36d0414a775f9dbe0586ce12723c75cea8794fabadd1f33100a9ee22f6da3826256c0ef.js integrity="sha512-f6gh7pRuWJRwMOXQB9NYN4EZIF4Wt0q00MYFYKNtBBSndfnb4Fhs4Scjx1zqh5T6ut0fMxAKnuIvbaOCYlbA7w==" crossorigin=anonymous></script><a id=rocket href=#top></a><script src=/js/totop.min.8c7573186baa30f09c49b5cf3176c3b105785324d961b3d5c2f7f099d14673160a29aeebdec25909d046aa14936cd43451e17664662d518550d5e8998dbec670.js integrity="sha512-jHVzGGuqMPCcSbXPMXbDsQV4UyTZYbPVwvfwmdFGcxYKKa7r3sJZCdBGqhSTbNQ0UeF2ZGYtUYVQ1eiZjb7GcA==" crossorigin=anonymous></script><script src=/js/clipboard.min.0765794be1674926c1a3810afcf039f605f367cb11cef727ad49e6aa70f9fca0a37d329d64c55822896869eb0960763e73e085ee7675cbc497e4d3256a6e6a67.js integrity="sha512-B2V5S+FnSSbBo4EK/PA59gXzZ8sRzvcnrUnmqnD5/KCjfTKdZMVYIoloaesJYHY+c+CF7nZ1y8SX5NMlam5qZw==" crossorigin=anonymous></script><script>var spy=new Gumshoe("#TableOfContents a",{nested:!0,nestedClass:"active"})</script><script>hljs.highlightAll()</script></div></div></body></html>